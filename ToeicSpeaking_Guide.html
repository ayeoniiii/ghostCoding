<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í† ìµìŠ¤í”¼í‚¹ ì§„ë„ ê´€ë¦¬ &amp; ê°€ì´ë“œ</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ê¸°ë³¸ í°íŠ¸ ì„¤ì • */
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3b82f6; /* Tailwind blue-500 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* íŒŒíŠ¸ë³„ ë²„íŠ¼ ìƒ‰ìƒ */
        .nav-part-1 { background-color: #3b82f6; } /* Blue 500 */
        .nav-part-2 { background-color: #f59e0b; } /* Amber 500 */
        .nav-part-3 { background-color: #9333ea; } /* Purple 600 */
        .nav-part-4 { background-color: #10b981; } /* Emerald 500 */
        .nav-part-5 { background-color: #ef4444; } /* Red 500 */

        /* í™œì„±í™”ëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .nav-btn.active.nav-part-1 { background-color: #2563eb; }
        .nav-btn.active.nav-part-2 { background-color: #d97706; }
        .nav-btn.active.nav-part-3 { background-color: #7e22ce; }
        .nav-btn.active.nav-part-4 { background-color: #059669; }
        .nav-btn.active.nav-part-5 { background-color: #dc2626; }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Firebase ë° Gemini API ë¡œì§ -->
    <script type="module">
        // Firebase SDK ë¡œë“œ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ì½˜ì†” ë¡œê·¸ ë””ë²„ê¹… ë ˆë²¨ ì„¤ì • (í•„ìˆ˜)
        setLogLevel('Debug');

        // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAuthReady = false;
        window.progressData = {};
        window.currentPart3Questions = null; // Part 3ëŠ” ì´ì œ 3ê°œ ì§ˆë¬¸ì„ ë°°ì—´ë¡œ ì €ì¥
        window.currentPart2Scenario = null; // í˜„ì¬ Part 2 ì—°ìŠµ ì‹œë‚˜ë¦¬ì˜¤ ì €ì¥ (ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ì €ì¥ìš©)
        window.currentPart4Data = null;      // í˜„ì¬ Part 4 ë„í‘œ JSON ë°ì´í„° ì €ì¥
        window.currentPart4Questions = [];   // í˜„ì¬ Part 4 ìƒì„±ëœ ì§ˆë¬¸ ëª©ë¡ ì €ì¥
        window.currentPart5Problem = null;    // í˜„ì¬ Part 5 ë¬¸ì œ í…ìŠ¤íŠ¸ ì €ì¥

        let part3TimerInterval; // Part 3 íƒ€ì´ë¨¸ ì¸í„°ë²Œ
        let part3CurrentQuestionIndex = 0; // Part 3 í˜„ì¬ ì§ˆë¬¸ ì¸ë±ìŠ¤
        let isPart3Running = false; // Part 3 íƒ€ì´ë¨¸ ìƒíƒœ í”Œë˜ê·¸

        let part4TimerInterval; // Part 4 íƒ€ì´ë¨¸ ì¸í„°ë²Œ
        let part4CurrentQuestionIndex = 0; // Part 4 í˜„ì¬ ì§ˆë¬¸ ì¸ë±ìŠ¤
        let isPart4Running = false; // Part 4 íƒ€ì´ë¨¸ ìƒíƒœ í”Œë˜ê·¸

        let part5TimerInterval; // Part 5 íƒ€ì´ë¨¸ ì¸í„°ë²Œ
        let isPart5Running = false; // Part 5 íƒ€ì´ë¨¸ ìƒíƒœ í”Œë˜ê·¸


        // Canvas í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const apiKey = ""; // API KeyëŠ” ëŸ°íƒ€ì„ì— ì£¼ì…ë©ë‹ˆë‹¤. **ë¡œì»¬ í™˜ê²½ì—ì„œëŠ” ì—¬ê¸°ì— í‚¤ë¥¼ ì§ì ‘ ë„£ì–´ì£¼ì„¸ìš”.**

        // --- TTS Helper Functions (PCM to WAV Conversion) ---

        /**
         * Base64 ë¬¸ìì—´ì„ ArrayBufferë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * 16ë¹„íŠ¸ PCM ë°ì´í„°ë¥¼ WAV Blobìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
         */
        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const buffer = new ArrayBuffer(44 + pcm16.byteLength);
            const dataView = new DataView(buffer);

            // RIFF chunk descriptor
            writeString(dataView, 0, 'RIFF');
            dataView.setUint32(4, 36 + pcm16.byteLength, true);
            writeString(dataView, 8, 'WAVE');

            // FMT chunk
            writeString(dataView, 12, 'fmt ');
            dataView.setUint32(16, 16, true); // chunkSize
            dataView.setUint16(20, 1, true); // wFormatTag (1 = PCM)
            dataView.setUint16(22, numChannels, true); // nChannels
            dataView.setUint32(24, sampleRate, true); // nSamplesPerSec
            dataView.setUint32(28, sampleRate * numChannels * 2, true); // nAvgBytesPerSec (SampleRate * Channel * 2 bytes/sample)
            dataView.setUint16(32, numChannels * 2, true); // nBlockAlign
            dataView.setUint16(34, 16, true); // wBitsPerSample (16 bit)

            // DATA chunk
            writeString(dataView, 36, 'data');
            dataView.setUint32(40, pcm16.byteLength, true);

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++, offset += 2) {
                dataView.setInt16(offset, pcm16[i], true);
            }

            return new Blob([buffer], { type: 'audio/wav' });

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }
        }
        
        // --- Gemini API Call Wrapper ---

        /**
         * Exponential Backoffì„ ì ìš©í•œ Fetch ìš”ì²­
         */
        async function fetchWithBackoff(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status === 429 || response.status >= 500) {
                        // Rate limit or server error: retry
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.warn(`Retrying API call after ${delay.toFixed(0)}ms (Attempt ${i + 1})`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    // Non-retryable error
                    const errorJson = await response.json();
                    throw new Error(`API Error ${response.status}: ${JSON.stringify(errorJson)}`);
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    // Network error: retry
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.warn(`Retrying fetch call after ${delay.toFixed(0)}ms (Attempt ${i + 1})`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        // --- Firebase Logic ---

        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase Configuration is missing.");
                document.getElementById('auth-status').textContent = 'âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨: ì„¤ì • ëˆ„ë½';
                return;
            }

            try {
                window.firebaseApp = initializeApp(firebaseConfig);
                window.auth = getAuth(window.firebaseApp);
                window.db = getFirestore(window.firebaseApp);

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        document.getElementById('auth-status').textContent = `âœ… ë¡œê·¸ì¸ ì„±ê³µ | User ID: ${window.userId.substring(0, 8)}...`;
                        console.log("Firebase Auth State Changed. User ID:", window.userId);
                        window.isAuthReady = true;
                        setupProgressListener();
                    } else {
                        window.userId = null;
                        document.getElementById('auth-status').textContent = 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.';
                        window.isAuthReady = false;
                    }
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

            } catch (error) {
                console.error("Firebase Initialization or Sign-in Error:", error);
                document.getElementById('auth-status').textContent = `âš ï¸ ë¡œê·¸ì¸ ì˜¤ë¥˜: ${error.code}`;
            }
        }

        function setupProgressListener() {
            if (!window.db || !window.userId) {
                console.warn("Database or User ID not available for listener setup.");
                return;
            }
            // ì „ì²´ ì—°ìŠµ íšŸìˆ˜ ë¦¬ìŠ¤ë„ˆ
            const progressDocRef = doc(window.db, `artifacts/${appId}/users/${window.userId}/study_progress/user_progress`);

            onSnapshot(progressDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.progressData = docSnap.data();
                } else {
                    window.progressData = {};
                }
                window.renderProgressDashboard();
            }, (error) => {
                console.error("Error setting up progress listener:", error);
            });
        }
        
        window.markPracticeDone = async function(partId) {
            if (!window.isAuthReady) {
                // ë¡œê·¸ì¸ ì¤‘ì´ë©´ ë°”ë¡œ ì €ì¥í•˜ì§€ ì•ŠìŒ.
                return;
            }

            const today = new Date().toISOString().substring(0, 10);
            const countKey = `${partId}_count`;
            const dateKey = `${partId}_last_date`;

            const newCount = (window.progressData[countKey] || 0) + 1;
            
            const updates = { [countKey]: newCount, [dateKey]: today };
            
            const progressDocRef = doc(window.db, `artifacts/${appId}/users/${window.userId}/study_progress/user_progress`);
            
            try {
                await setDoc(progressDocRef, updates, { merge: true });
                console.log(`Progress for ${partId} updated successfully.`);
            } catch (error) {
                console.error("Error updating progress:", error);
                // ì‚¬ìš©ìì—ê²Œ alert ëŒ€ì‹  ì½˜ì†”ì— ì˜¤ë¥˜ ë©”ì‹œì§€ ì¶œë ¥
            }
        }

        /**
         * Part 3 ì—°ìŠµ í›„ ë©”ëª¨ë¥¼ Firestoreì— ì €ì¥í•©ë‹ˆë‹¤.
         */
        window.savePart3Memo = async function() {
            if (!window.isAuthReady || !window.currentPart3Questions) {
                window.showAlert('ë¡œê·¸ì¸ ë˜ëŠ” ì§ˆë¬¸ ìƒì„± í›„ì— ë©”ëª¨ë¥¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'red');
                return;
            }
            
            const memoText = document.getElementById('part3-memo-input').value.trim();
            if (!memoText) {
                window.showAlert('ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'red');
                return;
            }

            const saveBtn = document.getElementById('save-memo-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'ì €ì¥ ì¤‘...';

            // Part 3 ì§ˆë¬¸ ë°°ê²½ê³¼ 3ê°œ ì§ˆë¬¸ì„ ëª¨ë‘ ì €ì¥
            const memoData = {
                timestamp: new Date().toISOString(),
                part: 'Part 3',
                context: window.currentPart3Questions.context,
                questions: window.currentPart3Questions.questions,
                memo_content: memoText,
            };

            // Private Memo storage path: /artifacts/{appId}/users/{userId}/study_memos/{doc_id}
            const memosCollectionRef = collection(window.db, `artifacts/${appId}/users/${window.userId}/study_memos`);
            
            try {
                // ê³ ìœ  IDë¡œ ë¬¸ì„œë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
                await setDoc(doc(memosCollectionRef, Date.now().toString()), memoData);
                
                window.showAlert('ë©”ëª¨ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'green');
                document.getElementById('part3-memo-input').value = ''; // ì…ë ¥ ì´ˆê¸°í™”
                window.currentPart3Questions = null; // í˜„ì¬ ì§ˆë¬¸ ì´ˆê¸°í™”
                
                // ë©”ëª¨ UI ìˆ¨ê¸°ê³  ë‹¤ìŒ ë¬¸ì œ ë²„íŠ¼ í‘œì‹œ
                document.getElementById('part3-memo-area').classList.add('hidden');
                document.getElementById('part3-control-buttons').classList.remove('hidden');
                document.getElementById('part3-question-context').textContent = 'ìƒˆë¡œìš´ ì£¼ì œ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìƒì„±í•˜ì—¬ ì—°ìŠµì„ ì‹œì‘í•˜ì„¸ìš”.';
                document.getElementById('part3-current-question').innerHTML = '<p class="text-gray-500">Q1~Q3 ì§ˆë¬¸ì´ ìˆœì„œëŒ€ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>';
                document.getElementById('part3-model-answer').innerHTML = '<p class="text-gray-500">ëª¨ë²” ë‹µë³€ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>';

            } catch (error) {
                console.error("Error saving memo:", error);
                window.showAlert('ë©”ëª¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'red');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'ë©”ëª¨ ê¸°ë¡ ì €ì¥';
                // ì „ì²´ Part 3 ì—°ìŠµ íšŸìˆ˜ë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤.
                window.markPracticeDone('part3');
            }
        }


        // --- Gemini API Functions ---

        /**
         * Part 1 ì§€ë¬¸ì„ ìƒì„±í•˜ê³  í…ìŠ¤íŠ¸ ì˜ì—­ì— ë„£ìŠµë‹ˆë‹¤. (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
         */
        window.generatePart1Passage = async function() {
            // ... (Part 1 ë¡œì§ ìœ ì§€)
            const btn = document.getElementById('generate-passage-btn');
            const textInput = document.getElementById('part1-tts-text');
            const loadingSpan = document.getElementById('part1-text-loading');
            
            btn.disabled = true;
            loadingSpan.classList.remove('hidden');
            textInput.value = 'ì§€ë¬¸ì„ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...';

            const systemPrompt = "You are a TOEIC Speaking test creator. Generate a single, short, formal English reading passage typical for Part 1 (e.g., an announcement, a commercial, or weather report). The passage must be 3-4 sentences long. Return only the text of the passage.";
            const userQuery = "Generate a new Part 1 reading passage.";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Failed to generate passage.";
                
                textInput.value = text.trim();
                window.markPracticeDone('part1'); // ì§€ë¬¸ ìƒì„± ì‹œ ì—°ìŠµ íšŸìˆ˜ ê¸°ë¡
            } catch (error) {
                console.error("Gemini API Error for Part 1:", error);
                textInput.value = 'ì§€ë¬¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            } finally {
                btn.disabled = false;
                loadingSpan.classList.add('hidden');
            }
        }
        
        /**
         * Part 1 ì§€ë¬¸ì˜ TTS ì˜¤ë””ì˜¤ ëª¨ë¸ì„ ìƒì„±í•©ë‹ˆë‹¤. (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
         */
        window.generatePart1Audio = async function() {
            // ... (Part 1 TTS ë¡œì§ ìœ ì§€)
            const textInput = document.getElementById('part1-tts-text');
            const audioPlayer = document.getElementById('part1-audio-player');
            const btn = document.getElementById('generate-tts-btn');
            const loadingSpan = document.getElementById('part1-loading');
            
            const text = textInput.value.trim();
            if (!text) {
                window.showAlert('ì§€ë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'red');
                return;
            }

            btn.disabled = true;
            loadingSpan.classList.remove('hidden');
            audioPlayer.src = '';

            const systemPrompt = "TTS the following passage for a formal announcement, ensuring clear pronunciation and natural pacing appropriate for a reading test like TOEIC Speaking.";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Rasalgethi" } // ëª…í™•í•˜ê³  ì •ë³´ ì „ë‹¬ì— ì í•©í•œ ìŒì„± ì„ íƒ
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    audioPlayer.src = audioUrl;
                    audioPlayer.play();
                } else {
                    throw new Error("Invalid audio data received.");
                }
            } catch (error) {
                console.error("Gemini TTS API Error:", error);
                window.showAlert('ì˜¤ë””ì˜¤ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'red');
            } finally {
                btn.disabled = false;
                loadingSpan.classList.add('hidden');
            }
        }
        
        /**
         * Part 2 ì‚¬ì§„ ë¬˜ì‚¬ ì‹œë‚˜ë¦¬ì˜¤(ì´ë¯¸ì§€)ë¥¼ ìƒì„±í•˜ê³  íƒ€ì´ë¨¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
         */
        window.generatePart2Practice = async function() {
            // ... (Part 2 ë¡œì§ ìœ ì§€)
            const peopleCount = document.getElementById('part2-people-count').value;
            const btn = document.getElementById('generate-part2-btn');
            const outputDiv = document.getElementById('part2-scenario-output');
            const timerDisplay = document.getElementById('part2-timer-display');
            const modelAnswerDiv = document.getElementById('part2-model-answer');
            const loadingSpan = document.getElementById('part2-loading');

            // UI ìƒíƒœ ì´ˆê¸°í™”
            btn.disabled = true;
            loadingSpan.classList.remove('hidden');
            modelAnswerDiv.innerHTML = '<p class="text-gray-500">ë‹µë³€ ì‹œê°„ì´ ì¢…ë£Œë˜ë©´ ëª¨ë²” ë‹µë³€ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>'; 
            outputDiv.innerHTML = '<div class="text-center p-8 text-gray-700">ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>';
            timerDisplay.textContent = 'ì¤€ë¹„';

            // ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸ (ë‹¤ìˆ˜ ì¸ì›ì¼ ê²½ìš° ë™ì ì¸ ì¥ì†Œì™€ ì›€ì§ì„ì„ ê°•ì¡°)
            let promptTemplate = `A high-quality, realistic photo of a scene featuring ${peopleCount} people. The setting is a professional environment like an office, conference room, or a modern public space like a cafe or airport. The photo should be clear, natural, and suitable for a business-level speaking test. Avoid static, posed photos.`;
            
            if (peopleCount === 'a large group of') {
                 promptTemplate = `A high-quality, realistic photo of a dynamic public scene featuring a large group of people (more than 4) in active settings like a bustling market, a busy street, a city square, a crosswalk, or an open plaza. The photo must capture people engaging in various actions (e.g., walking, talking, shopping). Avoid static or posed photos. Suitable for a business-level speaking test.`;
            }

            // --- Image Generation using Imagen 3.0 ---
            const imageApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
            const imagePayload = { 
                instances: { prompt: promptTemplate }, 
                parameters: { "sampleCount": 1 } 
            };
            
            let imageUrl = '';
            try {
                const response = await fetchWithBackoff(imageApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(imagePayload)
                });
                const result = await response.json();
                const base64Data = result?.predictions?.[0]?.bytesBase64Encoded;

                if (base64Data) {
                    imageUrl = `data:image/png;base64,${base64Data}`;
                } else {
                    throw new Error("Failed to generate image data.");
                }
            } catch (error) {
                console.error("Imagen API Error for Part 2:", error);
                outputDiv.innerHTML = '<div class="text-red-500 p-4">âš ï¸ ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>';
                btn.disabled = false;
                loadingSpan.classList.add('hidden');
                return;
            }

            // 2. ì´ë¯¸ì§€ í‘œì‹œ ë° í”„ë¡¬í”„íŠ¸ ì €ì¥ (í”„ë¡¬í”„íŠ¸ê°€ ì‹œë‚˜ë¦¬ì˜¤ í…ìŠ¤íŠ¸ë¥¼ ëŒ€ì²´í•¨)
            window.currentPart2Scenario = promptTemplate; // ëª¨ë²”ë‹µë³€ ìƒì„±ìš©ìœ¼ë¡œ í”„ë¡¬í”„íŠ¸ ì €ì¥
            outputDiv.innerHTML = `<img src="${imageUrl}" class="w-full h-auto rounded-lg shadow-xl" alt="AI Generated Part 2 Scenario Image">`;
            
            // íƒ€ì´ë¨¸ ìë™ ì‹œì‘: 30ì´ˆ ì¤€ë¹„ + 30ì´ˆ ë‹µë³€
            window.startPart2Timer(30, 30); 
            loadingSpan.classList.add('hidden');
        }

        /**
         * Part 2 ì‹¤ì „ íƒ€ì´ë¨¸ë¥¼ ê´€ë¦¬í•˜ê³  ì¢…ë£Œ ì‹œ ëª¨ë²” ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤. (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
         */
        let part2TimerInterval;
        window.startPart2Timer = function(prepTime, answerTime) {
            // ... (Part 2 Timer ë¡œì§ ìœ ì§€)
            const timerDisplay = document.getElementById('part2-timer-display');
            const startBtn = document.getElementById('generate-part2-btn');
            
            clearInterval(part2TimerInterval);
            startBtn.disabled = true;
            
            let time = prepTime;
            let isPrepPhase = true;
            timerDisplay.classList.remove('bg-green-500', 'bg-red-500', 'bg-gray-500');
            timerDisplay.classList.add('bg-orange-500');

            function updateTimer() {
                if (time < 0) {
                    if (isPrepPhase) {
                        // ì¤€ë¹„ ì‹œê°„ ì¢…ë£Œ, ë‹µë³€ ì‹œê°„ ì‹œì‘
                        timerDisplay.textContent = 'ë‹µë³€ ì‹œì‘';
                        timerDisplay.classList.remove('bg-orange-500');
                        timerDisplay.classList.add('bg-red-500');
                        isPrepPhase = false;
                        time = answerTime; 
                        return;
                    } else {
                        // ë‹µë³€ ì‹œê°„ ì¢…ë£Œ
                        clearInterval(part2TimerInterval);
                        timerDisplay.textContent = 'ì‹œê°„ ì¢…ë£Œ!';
                        timerDisplay.classList.remove('bg-red-500');
                        timerDisplay.classList.add('bg-green-500');
                        startBtn.disabled = false;
                        startBtn.textContent = 'ğŸ“¸ ìƒˆë¡œìš´ ì‹œë‚˜ë¦¬ì˜¤ ìë™ ìƒì„± & ì—°ìŠµ ì‹œì‘';
                        
                        // ëª¨ë²” ë‹µë³€ ìƒì„± ìš”ì²­ (í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ëª¨ë²” ë‹µë³€ ìƒì„±)
                        window.generatePart2ModelAnswer(window.currentPart2Scenario);

                        // ì—°ìŠµ íšŸìˆ˜ ê¸°ë¡
                        window.markPracticeDone('part2');
                        return;
                    }
                }
                
                const currentStage = isPrepPhase ? 'ì¤€ë¹„' : 'ë‹µë³€';
                timerDisplay.textContent = `${currentStage} : ${time.toString().padStart(2, '0')}ì´ˆ`;
                
                time--;
            }

            timerDisplay.textContent = `ì¤€ë¹„ : ${prepTime.toString().padStart(2, '0')}ì´ˆ`;
            part2TimerInterval = setInterval(updateTimer, 1000);
        }

        /**
         * Part 2 ì—°ìŠµ ì¢…ë£Œ í›„ ëª¨ë²” ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤. (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
         */
        window.generatePart2ModelAnswer = async function(scenarioText) {
            // ... (Part 2 Model Answer ë¡œì§ ìœ ì§€)
            const modelAnswerDiv = document.getElementById('part2-model-answer');
            modelAnswerDiv.innerHTML = '<div class="flex items-center space-x-2 text-blue-600"><span class="loading-spinner"></span><p>ëª¨ë²” ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤... (ìµœëŒ€ 8ë¬¸ì¥)</p></div>';

            // ëª¨ë²” ë‹µë³€ì„ ìµœëŒ€ 8ë¬¸ì¥ìœ¼ë¡œ ì œí•œí•˜ëŠ” ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì¶”ê°€
            const systemPrompt = "You are a professional TOEIC Speaking tutor. Based on the following picture prompt (which describes the scene), generate a concise and structured model answer for Part 2. The answer must be no more than 8 sentences long, strictly adhering to the sentence count constraint to fit the 30-second speaking time. The answer must include: 1. Introduction, 2. Main focus, 3. Details, 4. Background/Middle Ground, and 5. Conclusion. Use appropriate linking words and diverse vocabulary. Return only the model answer text.";
            const userQuery = `Generate a model answer for this photo description prompt: "${scenarioText}"`;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Failed to generate model answer.";
                
                modelAnswerDiv.innerHTML = `<div class="bg-green-100 p-4 rounded-lg whitespace-pre-line text-gray-800 border-l-4 border-green-500">${text.trim()}</div>`;
            } catch (error) {
                console.error("Gemini API Error for Part 2 Model Answer:", error);
                modelAnswerDiv.innerHTML = '<p class="text-red-500">ëª¨ë²” ë‹µë³€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }


        /**
         * Part 3ì˜ ë°°ê²½ ì‹œë‚˜ë¦¬ì˜¤ì™€ 3ê°€ì§€ ì§ˆë¬¸ì„ í•œ ë²ˆì— ìƒì„±í•©ë‹ˆë‹¤. (Q1, Q2, Q3)
         */
        window.generatePart3Questions = async function() {
            const btn = document.getElementById('start-group-drill-btn');
            const contextDiv = document.getElementById('part3-question-context');
            const currentQuestionDiv = document.getElementById('part3-current-question');
            const loadingSpan = document.getElementById('part3-drill-loading');
            const modelAnswerDiv = document.getElementById('part3-model-answer');
            const timerDisplay = document.getElementById('part3-timer-display');

            // UI ìƒíƒœ ë³€ê²½
            btn.disabled = true;
            loadingSpan.classList.remove('hidden');
            contextDiv.textContent = 'ì „ì²´ ì£¼ì œ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...';
            currentQuestionDiv.innerHTML = '<p class="text-gray-500">Q1~Q3 ì§ˆë¬¸ì´ ìˆœì„œëŒ€ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>';
            timerDisplay.textContent = 'ëŒ€ê¸°';
            document.getElementById('part3-memo-area').classList.add('hidden'); // ë©”ëª¨ ì˜ì—­ ìˆ¨ê¹€
            document.getElementById('part3-control-buttons').classList.add('hidden'); // ì»¨íŠ¸ë¡¤ ìˆ¨ê¹€ (ë‹¤ì‹œ í™œì„±í™”)
            modelAnswerDiv.innerHTML = '<p class="text-gray-500">ëª¨ë²” ë‹µë³€ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>';


            const systemPrompt = "You are a professional TOEIC Speaking test proctor. Generate a complete Part 3 telephone interview scenario. This includes: 1. A context setting (e.g., 'Imagine that a new department store is opening...'). 2. Exactly three structured questions: Q1 (15s, simple), Q2 (15s, typical item/activity), Q3 (30s, opinion/choice with reasons). Return the output as a JSON object.";
            const userQuery = "Generate a new Part 3 scenario focusing on a common consumer topic (e.g., shopping, travel, or services).";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "context": { "type": "STRING" },
                            "questions": {
                                "type": "ARRAY",
                                "items": { "type": "STRING" }
                            }
                        }
                    }
                }
            };

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!jsonText) throw new Error("No structured data received.");
                
                const data = JSON.parse(jsonText);
                
                if (data.questions.length !== 3) {
                     throw new Error("Generated questions array length is not 3.");
                }

                // ì „ì—­ ë³€ìˆ˜ì— í˜„ì¬ ì§ˆë¬¸ ì •ë³´ ì €ì¥
                window.currentPart3Questions = {
                    context: data.context.trim(),
                    questions: data.questions.map(q => q.trim())
                };

                // UI ì—…ë°ì´íŠ¸
                contextDiv.textContent = window.currentPart3Questions.context;
                currentQuestionDiv.innerHTML = '<p class="text-gray-600">ì§ˆë¬¸ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. **â–¶ï¸ ì—°ìŠµ ì‹œì‘** ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>';
                
                // íƒ€ì´ë¨¸ ì‹œì‘ ì¤€ë¹„
                document.getElementById('part3-control-buttons').classList.remove('hidden');
                
            } catch (error) {
                console.error("Gemini API Error for Part 3:", error);
                contextDiv.textContent = 'ì‹œë‚˜ë¦¬ì˜¤ ë° ì§ˆë¬¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            } finally {
                loadingSpan.classList.add('hidden');
                btn.disabled = false;
            }
        }
        
        /**
         * Part 3 ì‹¤ì „ íƒ€ì´ë¨¸ ë° ì§ˆë¬¸ ì‹œí€€ìŠ¤ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
         */
        window.startPart3Drill = function() {
            if (!window.currentPart3Questions || window.currentPart3Questions.questions.length !== 3) {
                window.showAlert("ë¨¼ì € ì§ˆë¬¸ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.", 'red');
                return;
            }
            
            const timerDisplay = document.getElementById('part3-timer-display');
            const controlButtons = document.getElementById('part3-control-buttons');
            
            clearInterval(part3TimerInterval);
            isPart3Running = true;
            controlButtons.classList.add('hidden'); 
            
            // 1. Q1 ì§ˆë¬¸ë¶€í„° ìˆœì°¨ì ìœ¼ë¡œ ì‹œì‘
            window.startPart3QuestionSequence(0);
        }

        /**
         * Part 3 ê°œë³„ ì§ˆë¬¸ (TTS -> ì¤€ë¹„ -> ë‹µë³€) ì‹œí€€ìŠ¤ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
         */
        window.startPart3QuestionSequence = function(qIndex) {
            if (qIndex >= window.currentPart3Questions.questions.length) {
                // ëª¨ë“  ì§ˆë¬¸ ì™„ë£Œ
                window.endPart3Drill();
                return;
            }
            
            const questionText = window.currentPart3Questions.questions[qIndex];
            const answerTimes = [15, 15, 30]; // Q1, Q2, Q3 ë‹µë³€ ì‹œê°„
            const currentQuestionDiv = document.getElementById('part3-current-question');
            
            currentQuestionDiv.innerHTML = `<p class="font-bold text-lg text-red-600">Question #${qIndex + 1} (ë‹µë³€ ${answerTimes[qIndex]}ì´ˆ):</p> <p>${questionText}</p>`;
            
            // 1. ì§ˆë¬¸ TTS ì¬ìƒ
            window.runPart3TTS(qIndex, questionText, () => {
                // 2. 3ì´ˆ ì¤€ë¹„ Phase (TTS ì¢…ë£Œ í›„ ì½œë°±)
                window.runPart3Phase('ì¤€ë¹„', 3, () => {
                    // 3. ë‹µë³€ Phase (ì¤€ë¹„ ì¢…ë£Œ í›„ ì½œë°±)
                    window.runPart3Phase('ë‹µë³€', answerTimes[qIndex], () => {
                        // 4. ë‹¤ìŒ ì§ˆë¬¸ ì‹œí€€ìŠ¤ ì‹œì‘ (ë‹µë³€ ì¢…ë£Œ í›„)
                        window.startPart3QuestionSequence(qIndex + 1);
                    });
                });
            });

            part3CurrentQuestionIndex = qIndex;
        }

        /**
         * Part 3 TTS ì¬ìƒì„ ê´€ë¦¬í•©ë‹ˆë‹¤. (ì¬ìƒ ì‹œê°„ = ëŒ€ê¸° ì‹œê°„)
         */
        window.runPart3TTS = async function(qIndex, questionText, callback) {
            const timerDisplay = document.getElementById('part3-timer-display');
            const audioPlayer = document.getElementById('part3-audio-player');
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            
            timerDisplay.classList.remove('bg-red-500', 'bg-gray-500', 'bg-orange-500');
            timerDisplay.classList.add('bg-yellow-500');
            timerDisplay.textContent = `Q${qIndex + 1} ì¬ìƒ ì¤‘...`;
            
            clearInterval(part3TimerInterval); // ë‹¤ë¥¸ íƒ€ì´ë¨¸ ì¤‘ì§€
            audioPlayer.src = '';

            const payload = {
                contents: [{ parts: [{ text: `Question ${qIndex + 1}. ${questionText}` }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    audioPlayer.src = audioUrl;
                    
                    audioPlayer.onended = () => {
                        if (callback) callback(); // TTS ì¬ìƒ ì™„ë£Œ í›„ ë‹¤ìŒ ë‹¨ê³„ë¡œ
                    };
                    
                    audioPlayer.play();
                } else {
                    throw new Error("Invalid audio data received or TTS failed.");
                }
            } catch (error) {
                console.error("Gemini TTS API Error for Part 3 Read:", error);
                window.showAlert(`Q${qIndex + 1} TTS ì˜¤ë¥˜. ì¤€ë¹„ ë‹¨ê³„ë¡œ ê°•ì œ ì´ë™í•©ë‹ˆë‹¤.`, 'red');
                if (callback) callback(); 
            }
        }
        
        /**
         * Part 3 íŠ¹ì • í˜ì´ì¦ˆ(ì¤€ë¹„, ë‹µë³€)ì˜ íƒ€ì´ë¨¸ë¥¼ ì‹¤í–‰í•˜ê³  ì½œë°±ì„ í˜¸ì¶œí•˜ëŠ” ë²”ìš© í•¨ìˆ˜
         */
        window.runPart3Phase = function(phaseName, duration, callback) {
            const timerDisplay = document.getElementById('part3-timer-display');
            
            clearInterval(part3TimerInterval);

            // UI ìƒ‰ìƒ ì„¤ì •
            if (phaseName === 'ì¤€ë¹„') timerDisplay.classList.replace('bg-yellow-500', 'bg-orange-500');
            else if (phaseName === 'ë‹µë³€') timerDisplay.classList.replace('bg-orange-500', 'bg-red-500');
            
            let time = duration;

            function updatePhaseTimer() {
                if (time < 0) {
                    clearInterval(part3TimerInterval);
                    if (callback) callback();
                    return;
                }
                
                timerDisplay.textContent = `${phaseName} : ${time.toString().padStart(2, '0')}ì´ˆ`;
                time--;
            }

            // ì´ˆê¸° í…ìŠ¤íŠ¸ ì„¤ì •
            timerDisplay.textContent = `${phaseName} : ${duration.toString().padStart(2, '0')}ì´ˆ`;
            part3TimerInterval = setInterval(updatePhaseTimer, 1000);
        }

        /**
         * Part 3 ë“œë¦´ ì™„ë£Œ ì²˜ë¦¬ (Q3 ë‹µë³€ ì¢…ë£Œ í›„ ì‹¤í–‰)
         */
        window.endPart3Drill = function() {
            const timerDisplay = document.getElementById('part3-timer-display');
            const controlButtons = document.getElementById('part3-control-buttons');
            const currentQuestionDiv = document.getElementById('part3-current-question');
            
            clearInterval(part3TimerInterval);
            isPart3Running = false;
            
            timerDisplay.textContent = 'ì—°ìŠµ ì™„ë£Œ!';
            timerDisplay.classList.remove('bg-red-500', 'bg-yellow-500', 'bg-gray-500', 'bg-orange-500');
            timerDisplay.classList.add('bg-green-500');
            
            // Q3 ëª¨ë²” ë‹µì•ˆ ìƒì„± ë° ë©”ëª¨ ì˜ì—­ í‘œì‹œ
            currentQuestionDiv.innerHTML = '<p class="text-xl font-bold text-green-700">Part 3 ì„¸íŠ¸ ì—°ìŠµì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</p>';
            window.generatePart3ModelAnswerSet(window.currentPart3Questions.questions);
            document.getElementById('part3-memo-area').classList.remove('hidden');
            controlButtons.classList.remove('hidden');
        }

        /**
         * Part 3 ì „ì²´ ì„¸íŠ¸ ì—°ìŠµ ì¢…ë£Œ í›„ ëª¨ë²” ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤.
         */
        window.generatePart3ModelAnswerSet = async function(questions) {
            const modelAnswerDiv = document.getElementById('part3-model-answer');
            modelAnswerDiv.innerHTML = '<div class="flex items-center space-x-2 text-blue-600"><span class="loading-spinner"></span><p>ëª¨ë²” ë‹µë³€ ì„¸íŠ¸ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</p></div>';

            const systemPrompt = `You are a professional TOEIC Speaking tutor. Based on the following three questions (Q1: 15s, Q2: 15s, Q3: 30s opinion), generate a structured model answer for each question. The Q3 answer must follow the P-R-D-R structure (Point-Reason-Detail-Reason). Return the answers as a JSON array of strings.`;
            const userQuery = `Generate model answers for this question set: ${JSON.stringify(questions)}`;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: { "type": "STRING" }
                    }
                }
            };

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const answers = result.candidates?.[0]?.content?.parts?.[0]?.text;
                const parsedAnswers = JSON.parse(answers);

                let answerHtml = '';
                parsedAnswers.forEach((ans, index) => {
                    const time = index === 2 ? '30ì´ˆ' : '15ì´ˆ';
                    answerHtml += `<div class="mb-4">
                        <p class="font-bold text-indigo-700">Q${index + 1} ëª¨ë²” ë‹µë³€ (${time})</p>
                        <div class="bg-white p-3 rounded-lg border border-gray-200 whitespace-pre-line text-gray-800">${ans}</div>
                    </div>`;
                });
                
                modelAnswerDiv.innerHTML = answerHtml;
            } catch (error) {
                console.error("Gemini API Error for Part 3 Model Answer Set:", error);
                modelAnswerDiv.innerHTML = '<p class="text-red-500">ëª¨ë²” ë‹µë³€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>';
            }
        }
        
        /**
         * Part 4 ë„í‘œ/ì¼ì •í‘œ ë°ì´í„°ë¥¼ ìƒì„±í•˜ê³  UIì— í…Œì´ë¸”ë¡œ ë Œë”ë§í•©ë‹ˆë‹¤. (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
         */
        window.generatePart4Data = async function() {
            // ... (Part 4 Data/Question ë¡œì§ ìœ ì§€)
            const btn = document.getElementById('generate-part4-btn');
            const outputDiv = document.getElementById('part4-data-output');
            const questionsDiv = document.getElementById('part4-questions-area');
            const loadingSpan = document.getElementById('part4-loading');
            const startBtn = document.getElementById('start-part4-drill-btn');
            
            // íƒ€ì´ë¨¸ ì´ˆê¸°í™” ë° ë²„íŠ¼ ë¹„í™œì„±í™”
            clearInterval(part4TimerInterval);
            part4CurrentQuestionIndex = 0;
            isPart4Running = false;
            document.getElementById('part4-timer-display').textContent = 'ëŒ€ê¸°';
            startBtn.disabled = true;
            startBtn.textContent = 'â–¶ï¸ ì—°ìŠµ ì‹œì‘ (45ì´ˆ ì¤€ë¹„)'; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
            
            // UI ì´ˆê¸°í™”
            btn.disabled = true;
            loadingSpan.classList.remove('hidden');
            outputDiv.innerHTML = '<p class="text-gray-500 p-4">ë„í‘œ ë°ì´í„°ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>';
            questionsDiv.classList.add('hidden');
            
            const systemPrompt = "You are a data generator for a professional English test. Create a realistic, single-day meeting schedule or conference itinerary.";
            const userQuery = "Generate a new corporate meeting schedule table.";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "title": { "type": "STRING", "description": "Title of the schedule, e.g., 'Annual Sales Kickoff Meeting Schedule'" },
                            "topic": { "type": "STRING", "description": "The main topic for the Part 4 questions based on this schedule." },
                            "schedule": {
                                "type": "ARRAY",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "Time": { "type": "STRING" },
                                        "Event": { "type": "STRING" },
                                        "Speaker": { "type": "STRING" },
                                        "Location": { "type": "STRING" }
                                    },
                                    "propertyOrdering": ["Time", "Event", "Speaker", "Location"]
                                }
                            }
                        }
                    }
                }
            };
            
            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!jsonText) throw new Error("No structured data received.");
                
                const data = JSON.parse(jsonText);
                window.currentPart4Data = data; // ì „ì—­ ë³€ìˆ˜ì— ë°ì´í„° ì €ì¥
                
                // HTML Table Rendering
                let tableHtml = `<div class="p-4 bg-white rounded-lg shadow-md border border-gray-200">`;
                tableHtml += `<h4 class="text-xl font-bold text-indigo-700 mb-2">${data.title || 'íšŒì˜ ì¼ì •í‘œ'}</h4>`;
                tableHtml += `<p class="text-sm text-gray-600 mb-4 border-b pb-2">Focus Topic: ${data.topic || 'General'}</p>`;
                tableHtml += `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-300">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">ì‹œê°„</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">ì´ë²¤íŠ¸/ì„¸ì…˜</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">ë°œí‘œì</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">ì¥ì†Œ</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200 text-sm">`;

                data.schedule.forEach(row => {
                    tableHtml += `
                        <tr class="hover:bg-indigo-50">
                            <td class="px-4 py-2 whitespace-nowrap font-medium text-gray-900">${row.Time}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-gray-700">${row.Event}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-gray-700">${row.Speaker}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-gray-700">${row.Location}</td>
                        </tr>`;
                });

                tableHtml += `</tbody></table></div></div>`;
                
                outputDiv.innerHTML = tableHtml;

                // ë„í‘œ ìƒì„± í›„, ë°”ë¡œ ì§ˆë¬¸ ìƒì„± ìš”ì²­
                await window.generatePart4Questions(data);
                
            } catch (error) {
                console.error("Gemini API Error for Part 4 Data:", error);
                outputDiv.innerHTML = '<p class="text-red-500 p-4">âš ï¸ ë„í‘œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. (API í˜¸ì¶œ ë˜ëŠ” ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜)</p>';
            } finally {
                btn.disabled = false;
                loadingSpan.classList.add('hidden');
            }
        }

        /**
         * Part 4 ë„í‘œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì§ˆë¬¸ 3ê°œë¥¼ ìƒì„±í•©ë‹ˆë‹¤. (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
         */
        window.generatePart4Questions = async function(data) {
            // ... (Part 4 Question ë¡œì§ ìœ ì§€)
            const questionsDiv = document.getElementById('part4-questions-area');
            const questionListDiv = document.getElementById('part4-question-list');
            const questionsLoadingSpan = document.getElementById('part4-questions-loading');
            const startBtn = document.getElementById('start-part4-drill-btn');

            questionsDiv.classList.add('hidden');
            questionsLoadingSpan.classList.remove('hidden');
            questionListDiv.innerHTML = '';
            
            const systemPrompt = "You are a professional TOEIC Speaking test proctor. The user will provide a meeting/conference schedule in JSON format. Generate exactly three typical Part 4 questions based on this data: Q1 (Simple data point, 15s), Q2 (Specific schedule detail, 15s), and Q3 (Misinformation or Comparison, 30s). Return the questions as a JSON array.";
            const userQuery = `Generate the three questions based on this schedule data: ${JSON.stringify(data)}`;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: { "type": "STRING" }
                    }
                }
            };
            
            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!jsonText) throw new Error("No structured questions received.");
                
                const questions = JSON.parse(jsonText);
                window.currentPart4Questions = questions; // ì§ˆë¬¸ ëª©ë¡ ì €ì¥

                let listHtml = '';
                questions.forEach((q, index) => {
                    const time = index === 2 ? '30ì´ˆ' : '15ì´ˆ';
                    listHtml += `<li class="p-2 border-b last:border-b-0" id="q-list-${index}">
                        <span class="font-bold text-indigo-700">Q${index + 1} (${time}):</span> ${q}
                    </li>`;
                });

                questionListDiv.innerHTML = `<ul class="list-none divide-y">${listHtml}</ul>`;
                questionsDiv.classList.remove('hidden');
                startBtn.disabled = false; // ì§ˆë¬¸ ìƒì„± ì™„ë£Œ í›„ ì—°ìŠµ ì‹œì‘ ë²„íŠ¼ í™œì„±í™”
                
            } catch (error) {
                console.error("Gemini API Error for Part 4 Questions:", error);
                questionListDiv.innerHTML = '<p class="text-red-500 p-4">âš ï¸ ì§ˆë¬¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
                questionsDiv.classList.remove('hidden'); // ìµœì†Œí•œì˜ UIëŠ” í‘œì‹œ
            } finally {
                questionsLoadingSpan.classList.add('hidden');
            }
        }
        
        /**
         * Part 4 íƒ€ì´ë¨¸ ë° ì§ˆë¬¸ ì‹œí€€ìŠ¤ë¥¼ ê´€ë¦¬í•˜ëŠ” ë©”ì¸ í•¨ìˆ˜ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
         */
        window.startPart4Drill = function() {
            // ... (Part 4 Drill ë¡œì§ ìœ ì§€)
            if (window.currentPart4Questions.length === 0) {
                window.showAlert("ë¨¼ì € ë„í‘œì™€ ì§ˆë¬¸ì„ ìƒì„±í•´ì£¼ì„¸ìš”.", 'red');
                return;
            }
            
            const timerDisplay = document.getElementById('part4-timer-display');
            const startBtn = document.getElementById('start-part4-drill-btn');
            const generateBtn = document.getElementById('generate-part4-btn');
            
            clearInterval(part4TimerInterval);
            isPart4Running = true;
            startBtn.disabled = true;
            generateBtn.disabled = true;
            part4CurrentQuestionIndex = 0;

            // ì§ˆë¬¸ í•˜ì´ë¼ì´íŠ¸ ì´ˆê¸°í™”
            window.currentPart4Questions.forEach((_, index) => {
                document.getElementById(`q-list-${index}`).classList.remove('bg-yellow-200', 'font-extrabold', 'shadow-md');
            });

            // 1. ì¤€ë¹„ ì‹œê°„ 45ì´ˆ ì‹œì‘
            window.runPart4Phase('ì¤€ë¹„', 45, () => {
                // ì¤€ë¹„ ì‹œê°„ ì¢…ë£Œ í›„ Q10 ì‹œì‘
                window.startPart4QuestionSequence(0);
            });
        }
        
        /**
         * Part 4 íŠ¹ì • í˜ì´ì¦ˆ(ì¤€ë¹„, ë‹µë³€, ëŒ€ê¸°)ì˜ íƒ€ì´ë¨¸ë¥¼ ì‹¤í–‰í•˜ê³  ì½œë°±ì„ í˜¸ì¶œí•˜ëŠ” ë²”ìš© í•¨ìˆ˜ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
         */
        window.runPart4Phase = function(phaseName, duration, callback) {
            // ... (Part 4 Phase ë¡œì§ ìœ ì§€)
            const timerDisplay = document.getElementById('part4-timer-display');
            
            clearInterval(part4TimerInterval);

            // UI ìƒ‰ìƒ ì„¤ì •
            if (phaseName === 'ì¤€ë¹„') timerDisplay.classList.replace('bg-gray-500', 'bg-orange-500');
            else if (phaseName === 'ëŒ€ê¸°') timerDisplay.classList.replace('bg-red-500', 'bg-gray-500');
            else if (phaseName === 'ë‹µë³€') timerDisplay.classList.replace('bg-yellow-500', 'bg-red-500');
            
            let time = duration;

            function updatePhaseTimer() {
                if (time < 0) {
                    clearInterval(part4TimerInterval);
                    if (callback) callback();
                    return;
                }
                
                timerDisplay.textContent = `${phaseName} : ${time.toString().padStart(2, '0')}ì´ˆ`;
                time--;
            }

            // ì´ˆê¸° í…ìŠ¤íŠ¸ ì„¤ì •
            timerDisplay.textContent = `${phaseName} : ${duration.toString().padStart(2, '0')}ì´ˆ`;
            part4TimerInterval = setInterval(updatePhaseTimer, 1000);
        }

        /**
         * Part 4 ê°œë³„ ì§ˆë¬¸ (TTS -> ë‹µë³€ -> ëŒ€ê¸°) ì‹œí€€ìŠ¤ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
         */
        window.startPart4QuestionSequence = function(qIndex) {
            // ... (Part 4 Question Sequence ë¡œì§ ìœ ì§€)
            if (qIndex >= window.currentPart4Questions.length) {
                // ëª¨ë“  ì§ˆë¬¸ ì™„ë£Œ
                window.endPart4Drill();
                return;
            }

            const questionText = window.currentPart4Questions[qIndex];
            const listElement = document.getElementById(`q-list-${qIndex}`);
            const questionTimes = [15, 15, 30]; 

            // 1. ì§ˆë¬¸ í•˜ì´ë¼ì´íŠ¸ UI
            window.currentPart4Questions.forEach((_, idx) => {
                document.getElementById(`q-list-${idx}`).classList.remove('bg-yellow-200', 'font-extrabold', 'shadow-md');
            });
            listElement.classList.add('bg-yellow-200', 'font-extrabold', 'shadow-md');
            
            // 2. TTS ì¬ìƒ
            window.runPart4TTS(qIndex, questionText, () => {
                // 3. ë‹µë³€ Phase (TTS ì¢…ë£Œ í›„ ì½œë°±)
                window.runPart4Phase('ë‹µë³€', questionTimes[qIndex], () => {
                    // 4. ë‹¤ìŒ ì§ˆë¬¸ ë˜ëŠ” ì¢…ë£Œ
                    if (qIndex < window.currentPart4Questions.length - 1) {
                        window.runPart4Phase('ëŒ€ê¸°', 3, () => {
                            window.startPart4QuestionSequence(qIndex + 1); // ë‹¤ìŒ ì§ˆë¬¸ ì‹œì‘
                        });
                    } else {
                        window.endPart4Drill();
                    }
                });
            });

            part4CurrentQuestionIndex = qIndex; // ì „ì—­ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸
        }
        
        /**
         * Part 4 TTS ì¬ìƒì„ ê´€ë¦¬í•©ë‹ˆë‹¤. (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
         */
        window.runPart4TTS = async function(qIndex, questionText, callback) {
            // ... (Part 4 TTS ë¡œì§ ìœ ì§€)
            const timerDisplay = document.getElementById('part4-timer-display');
            const audioPlayer = document.getElementById('part4-audio-player');
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            
            timerDisplay.classList.remove('bg-red-500', 'bg-gray-500', 'bg-orange-500');
            timerDisplay.classList.add('bg-yellow-500');
            timerDisplay.textContent = `Q${qIndex + 1} ì¬ìƒ ì¤‘...`;
            
            clearInterval(part4TimerInterval); // ë‹¤ë¥¸ íƒ€ì´ë¨¸ ì¤‘ì§€
            audioPlayer.src = '';

            const payload = {
                contents: [{ parts: [{ text: `Question ${qIndex + 1}. ${questionText}` }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: { prebuiltVoiceConfig: { voiceName: "Charon" } }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    audioPlayer.src = audioUrl;
                    
                    audioPlayer.onended = () => {
                        if (callback) callback(); // TTS ì¬ìƒ ì™„ë£Œ í›„ ë‹¤ìŒ ë‹¨ê³„ë¡œ
                    };
                    
                    audioPlayer.play();
                } else {
                    throw new Error("Invalid audio data received or TTS failed.");
                }
            } catch (error) {
                console.error("Gemini TTS API Error for Part 4 Read:", error);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ë‹µë³€ ë‹¨ê³„ë¡œ ê°•ì œ ì´ë™ (ì‹¤ì „ì²˜ëŸ¼ ëŒ€ê¸° ì—†ì´ ë‹¤ìŒ ë‹¨ê³„)
                window.showAlert(`Q${qIndex + 1} TTS ì˜¤ë¥˜. ë‹µë³€ ë‹¨ê³„ë¡œ ê°•ì œ ì´ë™í•©ë‹ˆë‹¤.`, 'red');
                if (callback) callback(); 
            }
        }
        
        /**
         * Part 4 ë“œë¦´ ì™„ë£Œ ì²˜ë¦¬ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
         */
        window.endPart4Drill = function() {
            // ... (Part 4 End Drill ë¡œì§ ìœ ì§€)
            const timerDisplay = document.getElementById('part4-timer-display');
            const startBtn = document.getElementById('start-part4-drill-btn');
            const generateBtn = document.getElementById('generate-part4-btn');
            
            clearInterval(part4TimerInterval);
            isPart4Running = false;
            timerDisplay.textContent = 'ì—°ìŠµ ì™„ë£Œ!';
            timerDisplay.classList.remove('bg-red-500', 'bg-yellow-500', 'bg-gray-500', 'bg-orange-500');
            timerDisplay.classList.add('bg-green-500');
            startBtn.disabled = false;
            startBtn.textContent = 'â–¶ï¸ ì—°ìŠµ ì‹œì‘ (45ì´ˆ ì¤€ë¹„)';
            generateBtn.disabled = false;
            window.markPracticeDone('part4');
        }


        /**
         * Part 5 ë¬¸ì œ ì‹œë‚˜ë¦¬ì˜¤(ì˜ê²¬ ì œì‹œ ì£¼ì œ)ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. (ë¬¸ì œ í˜•ì‹ ë³€ê²½)
         */
        window.generatePart5Problem = async function() {
            const btn = document.getElementById('generate-part5-btn');
            const outputDiv = document.getElementById('part5-problem-output');
            const modelAnswerDiv = document.getElementById('part5-model-answer');
            const loadingSpan = document.getElementById('part5-loading');
            const timerDisplay = document.getElementById('part5-timer-display');
            const startBtn = document.getElementById('start-part5-drill-btn');


            // íƒ€ì´ë¨¸ ì´ˆê¸°í™” ë° ë²„íŠ¼ ë¹„í™œì„±í™”
            clearInterval(part5TimerInterval);
            isPart5Running = false;
            document.getElementById('part5-timer-display').textContent = 'ëŒ€ê¸°';
            startBtn.disabled = false;
            startBtn.textContent = 'â–¶ï¸ ì—°ìŠµ ì‹œì‘ (45ì´ˆ ì¤€ë¹„)'; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
            
            btn.disabled = true;
            loadingSpan.classList.remove('hidden');
            outputDiv.textContent = 'ìƒˆë¡œìš´ ì˜ê²¬ ì œì‹œ ì£¼ì œë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...';
            outputDiv.classList.remove('whitespace-pre-line');
            modelAnswerDiv.innerHTML = '<p class="text-gray-500">ë‹µë³€ ì‹œê°„ì´ ì¢…ë£Œë˜ë©´ ëª¨ë²” ë‹µë³€ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>'; 

            // ë¬¸ì œ í˜•ì‹: choose one of the options below and give reasons or examples to support your opinion.
            const systemPrompt = "You are a professional TOEIC Speaking test proctor. Generate a complete Part 5 'Express an Opinion' task. This includes: 1. A leading question (e.g., 'Which of the following do you think is the best experience for university students?'). 2. Exactly three distinct and relevant options. Return the task as a JSON object.";
            const userQuery = "Generate a new Part 5 opinion task suitable for an agree/disagree or choice format, focusing on a business or educational topic.";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "question": { "type": "STRING" },
                            "options": {
                                "type": "ARRAY",
                                "items": { "type": "STRING" }
                            }
                        }
                    }
                }
            };

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const data = result.candidates?.[0]?.content?.parts?.[0]?.text;
                const parsedData = JSON.parse(data);

                if (!parsedData.question || parsedData.options.length < 2) {
                    throw new Error("Invalid Part 5 data structure.");
                }

                // ë¬¸ì œ í…ìŠ¤íŠ¸ í¬ë§·íŒ…
                let problemText = `${parsedData.question}\n\nchoose one of the options below and give reasons or examples to support your opinion.\n\n`;
                parsedData.options.forEach(opt => {
                    problemText += `- ${opt}\n`;
                });
                
                window.currentPart5Problem = problemText.trim(); // ë¬¸ì œ í…ìŠ¤íŠ¸ ì €ì¥
                outputDiv.textContent = window.currentPart5Problem;
                outputDiv.classList.add('whitespace-pre-line'); // ì¤„ë°”ê¿ˆ ì ìš©
            } catch (error) {
                console.error("Gemini API Error for Part 5:", error);
                outputDiv.textContent = 'ë¬¸ì œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                startBtn.disabled = true;
            } finally {
                btn.disabled = false;
                loadingSpan.classList.add('hidden');
            }
        }
        
        /**
         * Part 5 ì‹¤ì „ íƒ€ì´ë¨¸ë¥¼ ê´€ë¦¬í•˜ê³  ì¢…ë£Œ ì‹œ ëª¨ë²” ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤. (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
         */
        window.startPart5Drill = function() {
            // ... (Part 5 Drill ë¡œì§ ìœ ì§€)
            if (!window.currentPart5Problem) {
                window.showAlert("ë¨¼ì € ë¬¸ì œ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.", 'red');
                return;
            }
            
            const timerDisplay = document.getElementById('part5-timer-display');
            const startBtn = document.getElementById('start-part5-drill-btn');
            const generateBtn = document.getElementById('generate-part5-btn');

            clearInterval(part5TimerInterval);
            isPart5Running = true;
            startBtn.disabled = true;
            generateBtn.disabled = true;
            
            let time = 45; // ì¤€ë¹„ ì‹œê°„ 45ì´ˆ
            let isPrepPhase = true;

            timerDisplay.classList.remove('bg-green-500', 'bg-red-500', 'bg-gray-500');
            timerDisplay.classList.add('bg-orange-500');
            startBtn.textContent = 'â±ï¸ ì—°ìŠµ ì§„í–‰ ì¤‘...';

            function updateTimer() {
                if (time < 0) {
                    if (isPrepPhase) {
                        // ì¤€ë¹„ ì‹œê°„ ì¢…ë£Œ, ë‹µë³€ ì‹œê°„ ì‹œì‘
                        timerDisplay.textContent = 'ë‹µë³€ ì‹œì‘';
                        timerDisplay.classList.remove('bg-orange-500');
                        timerDisplay.classList.add('bg-red-500');
                        isPrepPhase = false;
                        time = 60; // ë‹µë³€ ì‹œê°„ 60ì´ˆ
                        return;
                    } else {
                        // ë‹µë³€ ì‹œê°„ ì¢…ë£Œ
                        clearInterval(part5TimerInterval);
                        isPart5Running = false;
                        timerDisplay.textContent = 'ì‹œê°„ ì¢…ë£Œ!';
                        timerDisplay.classList.remove('bg-red-500');
                        timerDisplay.classList.add('bg-green-500');
                        startBtn.textContent = 'âœ… ì—°ìŠµ ì™„ë£Œ (ê¸°ë¡ë¨)';
                        generateBtn.disabled = false;
                        
                        // ëª¨ë²” ë‹µë³€ ìƒì„± ìš”ì²­
                        window.generatePart5ModelAnswer(window.currentPart5Problem);

                        // ì—°ìŠµ íšŸìˆ˜ ê¸°ë¡
                        window.markPracticeDone('part5');
                        return;
                    }
                }
                
                const currentStage = isPrepPhase ? 'ì¤€ë¹„' : 'ë‹µë³€';
                timerDisplay.textContent = `${currentStage} : ${time.toString().padStart(2, '0')}ì´ˆ`;
                
                time--;
            }

            timerDisplay.textContent = `ì¤€ë¹„ : ${time.toString().padStart(2, '0')}ì´ˆ`;
            part5TimerInterval = setInterval(updateTimer, 1000);
        }
        
        /**
         * Part 5 ì—°ìŠµ ì¢…ë£Œ í›„ ëª¨ë²” ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤. (ë§ŒëŠ¥ í…œí”Œë¦¿ ì‚¬ìš© ê°•ì¡°) (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
         */
        window.generatePart5ModelAnswer = async function(questionText) {
            // ... (Part 5 Model Answer ë¡œì§ ìœ ì§€)
            const modelAnswerDiv = document.getElementById('part5-model-answer');
            modelAnswerDiv.innerHTML = '<div class="flex items-center space-x-2 text-blue-600"><span class="loading-spinner"></span><p>ëª¨ë²” ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</p></div>';

            // ì‚¬ìš©ì ìš”ì²­ ê¸°ë°˜ì˜ êµ¬ì¡° ë° ë§ŒëŠ¥ ë¬¸ì¥ í†µí•©
            const structuralGuidance = `
                The model answer must strictly follow this structure suitable for a 60-second response:
                1.  **Decision/Stance (ì…ì¥ ê²°ì •):** Start with an opinion (I agree/disagree/I would prefer [Option]). Follow with a linking sentence (e.g., Let me explain why I think this way.).
                2.  **Reason 1 (ì´ìœ  ì„¤ëª…):** Start with 'Most of all,'. Use collective subjects (we, they, leaders, etc.) instead of 'I' to increase persuasive power.
                3.  **Example/Detail (ì˜ˆì‹œ ì„¤ëª…):** Support Reason 1 with a personal or reported experience (e.g., 'From my experience,' or 'According to a recent news reports,'). Use linking words (And / So / Because) to connect short sentences.
                4.  **Reason 2 / Conclusion (ë§ˆë¬´ë¦¬):** Provide a second brief reason or summarize the argument. End with a strong concluding sentence (e.g., 'Therefore, I think this way.' or an 'As a result' phrase).
            
                Utilize several of these versatile phrases throughout the response to show proficiency and fill time:
                - They can make a friendly work atmosphere.
                - Employees can work more efficiently and productively.
                - Itâ€™s very fun and entertaining.
                - Most of all, we can get a lot of useful information from a wide variety of products.
                - Most of all, we can live a comfortable life financially.
                - As a result, I was able to enjoy work.
                - As a result, I could forget my worries about stress.
                - It could be difficult to concentrate on studies.
            `;

            const systemPrompt = "You are a professional TOEIC Speaking tutor. Based on the Part 5 statement/question below, generate a 60-second model response. " + structuralGuidance;
            const userQuery = `Generate a model response for this Part 5 opinion task: "${questionText}"`;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Failed to generate model solution.";
                
                modelAnswerDiv.innerHTML = `<div class="bg-green-100 p-4 rounded-lg whitespace-pre-line text-gray-800 border-l-4 border-green-500">${text.trim()}</div>`;
            } catch (error) {
                console.error("Gemini API Error for Part 5 Model Answer:", error);
                modelAnswerDiv.innerHTML = '<p class="text-red-500">ëª¨ë²” ë‹µë³€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }


        // í˜ì´ì§€ ë¡œë“œ ì‹œ Firebase ì´ˆê¸°í™” ì‹œì‘
        window.addEventListener('DOMContentLoaded', initializeFirebase);
        
        // --- Custom Alert Function ---
        window.showAlert = function(message, type) {
            const alertBox = document.getElementById('alert-message');
            alertBox.textContent = message;
            alertBox.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'opacity-0');
            
            if (type === 'green') {
                alertBox.classList.add('bg-green-500', 'opacity-100');
            } else if (type === 'red') {
                alertBox.classList.add('bg-red-500', 'opacity-100');
            } else {
                alertBox.classList.add('bg-indigo-500', 'opacity-100');
            }

            setTimeout(() => {
                alertBox.classList.add('opacity-0');
                alertBox.classList.remove('opacity-100');
                setTimeout(() => {
                    alertBox.classList.add('hidden');
                }, 500);
            }, 3000);
        }
    </script>


    <!-- UI ìŠ¤í¬ë¦½íŠ¸ (HTML ë¡œì§) -->
    <script>
        // ì „ì—­ ë³€ìˆ˜ëŠ” ìœ„ Firebase ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.
        const navButtons = document.querySelectorAll('.nav-btn');
        const alertMessage = document.getElementById('alert-message');
        const progressDashboard = document.getElementById('progress-dashboard');
        
        const activeClass = 'bg-white text-gray-900 border-b-4 border-white shadow-xl transform scale-[1.05]';
        const inactiveClass = 'text-white/80 hover:bg-white/10';
        
        // íŒŒíŠ¸ ID ëª©ë¡
        const partIds = ['part1', 'part2', 'part3', 'part4', 'part5'];
        const partColors = {
            'part1': 'nav-part-1',
            'part2': 'nav-part-2',
            'part3': 'nav-part-3',
            'part4': 'nav-part-4',
            'part5': 'nav-part-5',
        };

        /**
         * íŒŒíŠ¸ë³„ í•™ìŠµ ì§„ë„ ëŒ€ì‹œë³´ë“œë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        window.renderProgressDashboard = function() {
            let htmlContent = '';
            
            // TypeError ë°©ì§€ë¥¼ ìœ„í•´ window.progressDataê°€ ìœ íš¨í•œ ê°ì²´ì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤.
            const data = window.progressData && typeof window.progressData === 'object' ? window.progressData : {};

            partIds.forEach(partId => {
                const countKey = `${partId}_count`;
                const dateKey = `${partId}_last_date`;
                const partNumber = partId.replace('part', '');
                
                const count = data[countKey] || 0;
                const lastDate = data[dateKey] || 'ê¸°ë¡ ì—†ìŒ';

                htmlContent += `
                    <div class="bg-white p-4 rounded-lg shadow-md border border-gray-100">
                        <h4 class="font-semibold text-lg text-indigo-700">Part ${partNumber}</h4>
                        <p class="text-3xl font-extrabold text-gray-900 mt-1">${count}íšŒ</p>
                        <p class="text-xs text-gray-500 mt-1">ë§ˆì§€ë§‰ ì—°ìŠµ: ${lastDate}</p>
                    </div>
                `;
            });

            progressDashboard.innerHTML = htmlContent;
        }

        // ì´ˆê¸°í™” ë° ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì ìš©
        window.addEventListener('DOMContentLoaded', function() {
            // ì´ˆê¸° Part 1 í‘œì‹œ ì„¤ì •
            document.querySelectorAll('.study-part').forEach(el => el.classList.add('hidden'));
            const part1 = document.getElementById('part1');
            if (part1) part1.classList.remove('hidden');
            
            // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸° ì„¤ì •
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const partId = btn.getAttribute('data-part');
                const colorClass = partColors[partId];
                
                // ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì ìš©
                btn.classList.add('py-2', 'px-4', 'rounded-lg', 'font-bold', 'text-sm', 'transition', 'duration-200', 'shadow-md', 'border-none', colorClass);
                
                // Part 1ë§Œ ì´ˆê¸°ì— í™œì„±í™”
                if (partId === 'part1') {
                    btn.classList.add('active', ...activeClass.split(' '));
                    btn.classList.remove(...inactiveClass.split(' '));
                } else {
                    btn.classList.remove('active', ...activeClass.split(' '));
                    btn.classList.add(...inactiveClass.split(' '));
                }
            });

            // ì´ˆê¸° ëŒ€ì‹œë³´ë“œ ë Œë”ë§ (ë°ì´í„°ê°€ ì—†ë”ë¼ë„ ë¹ˆ ìƒíƒœë¡œ ì´ˆê¸°í™”)
            window.renderProgressDashboard();
        });


        /**
         * ì„ íƒëœ íŒŒíŠ¸ì˜ ì½˜í…ì¸ ë§Œ í‘œì‹œí•˜ê³ , ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ì„ ë³€ê²½í•©ë‹ˆë‹¤.
         */
        function showPart(partId) {
            document.querySelectorAll('.study-part').forEach(el => el.classList.add('hidden'));

            const targetPart = document.getElementById(partId);
            if (targetPart) {
                targetPart.classList.remove('hidden');
                // ì½˜í…ì¸ ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active', ...activeClass.split(' '));
                btn.classList.add(...inactiveClass.split(' '));

                if (btn.getAttribute('data-part') === partId) {
                    btn.classList.add('active', ...activeClass.split(' '));
                    btn.classList.remove(...inactiveClass.split(' '));
                }
            });
        }


        /**
         * í˜„ì¬ ì›¹ì‚¬ì´íŠ¸ ì£¼ì†Œë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬í•˜ê³  ì•Œë¦¼ì„ í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function copyShareLink() {
            const url = window.location.href;
            const el = document.createElement('textarea');
            el.value = url;
            document.body.appendChild(el);
            el.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    window.showAlert('ğŸ”— ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'green');
                }
            } catch (err) {
                window.showAlert('âš ï¸ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'red');
            } finally {
                document.body.removeChild(el);
            }
        }
    </script>


    <!-- UI êµ¬ì¡° ì‹œì‘ -->
    <header class="bg-indigo-700 text-white shadow-xl p-4 sticky top-0 z-30">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex flex-col">
                <h1 class="text-2xl font-bold tracking-tight">
                    TOEIC Speaking <span class="text-yellow-300">í•µì‹¬ ë¹„ë²•ì„œ</span>
                </h1>
                <p id="auth-status" class="text-xs text-indigo-200 mt-1">ë¡œê·¸ì¸ ì¤‘...</p>
            </div>
            <button onclick="copyShareLink()" class="bg-indigo-500 hover:bg-indigo-400 text-white font-semibold py-2 px-4 rounded-lg text-sm shadow-md transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-300">
                ğŸš€ ê³µìœ í•˜ê¸°
            </button>
        </div>
    </header>

    <main class="flex-grow max-w-4xl mx-auto w-full p-4 sm:p-6 lg:p-8">

        <!-- ì•Œë¦¼ ë©”ì‹œì§€ ì˜ì—­ -->
        <div id="alert-message" class="hidden fixed top-20 left-1/2 transform -translate-x-1/2 text-white p-3 rounded-lg shadow-xl z-50 transition duration-300 ease-in-out opacity-0">
            ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!
        </div>

        <!-- í•™ìŠµ ì§„ë„ ëŒ€ì‹œë³´ë“œ -->
        <div class="mb-8 bg-gray-50 p-6 rounded-xl shadow-inner border border-gray-200">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ë‚˜ì˜ í•™ìŠµ ì§„ë„ ìš”ì•½</h3>
            <div id="progress-dashboard" class="grid grid-cols-2 sm:grid-cols-5 gap-4">
                <!-- ì§„ë„ ë°ì´í„°ëŠ” JSì—ì„œ ë Œë”ë§ë©ë‹ˆë‹¤. -->
            </div>
        </div>


        <!-- íŒŒíŠ¸ë³„ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ (ìŠ¤í‹°í‚¤ ê°œì„ ) -->
        <nav class="bg-indigo-700 p-3 rounded-xl shadow-xl sticky top-[72px] z-20 mb-6 border-t-4 border-indigo-600">
            <div class="max-w-4xl mx-auto flex flex-wrap justify-center gap-3">
                <button data-part="part1" class="nav-btn nav-part-1" onclick="showPart('part1')">Part 1: ì§€ë¬¸ ì½ê¸°</button>
                <button data-part="part2" class="nav-btn nav-part-2" onclick="showPart('part2')">Part 2: ì‚¬ì§„ ë¬˜ì‚¬</button>
                <button data-part="part3" class="nav-btn nav-part-3" onclick="showPart('part3')">Part 3: ì§ˆë¬¸ ì‘ë‹µ</button>
                <button data-part="part4" class="nav-btn nav-part-4" onclick="showPart('part4')">Part 4: ì •ë³´ í™œìš©</button>
                <button data-part="part5" class="nav-btn nav-part-5" onclick="showPart('part5')">Part 5: í•´ê²°ì±… ì œì‹œ</button>
            </div>
        </nav>


        <!-- === ì½˜í…ì¸  ì˜ì—­ === -->
        <section id="content-container" class="space-y-8">
            
            <!-- Part 1 ì½˜í…ì¸  (ì§€ë¬¸ ìë™ ìƒì„± ë° TTS ê¸°ëŠ¥ ì¶”ê°€) -->
            <article id="part1" class="study-part bg-white p-6 sm:p-8 rounded-xl shadow-2xl border-t-4 border-indigo-600">
                <h2 class="text-3xl font-extrabold text-indigo-700 mb-4">Part 1: ì§€ë¬¸ ì½ê¸° (Read a text aloud)</h2>
                <p class="text-gray-600 mb-6">ì¤€ë¹„ ì‹œê°„ 45ì´ˆ, ë‹µë³€ ì‹œê°„ 45ì´ˆ | 2ë¬¸í•­</p>

                <div class="space-y-6">
                    <div class="bg-indigo-50 p-4 rounded-lg border-l-4 border-indigo-400">
                        <h3 class="text-xl font-semibold text-indigo-800 mb-2">âœ¨ Gemini TTS &amp; ì§€ë¬¸ ìƒì„±</h3>
                        <p class="text-gray-700 text-sm mb-3">ì§€ë¬¸ ìë™ ìƒì„± í›„, TTS ëª¨ë¸ì˜ ì™„ë²½í•œ ë°œìŒê³¼ ì–µì–‘ì„ ë“£ê³  ë”°ë¼ ì—°ìŠµí•˜ì„¸ìš”.</p>
                        
                        <div class="flex items-center space-x-3 mb-3">
                            <button id="generate-passage-btn" onclick="window.generatePart1Passage()" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 disabled:opacity-50 flex items-center">
                                ğŸ“ ìƒˆë¡œìš´ Part 1 ì§€ë¬¸ ìë™ ìƒì„±
                            </button>
                            <span id="part1-text-loading" class="hidden loading-spinner"></span>
                        </div>

                        <textarea id="part1-tts-text" class="w-full p-2 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm" rows="3" placeholder="ì—¬ê¸°ì— Part 1 ì§€ë¬¸ì„ ì…ë ¥í•˜ê±°ë‚˜, ìë™ ìƒì„± ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”."></textarea>
                        
                        <div class="flex items-center space-x-4 mt-3">
                            <button id="generate-tts-btn" onclick="window.generatePart1Audio()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 disabled:opacity-50 flex items-center">
                                âœ¨ ì˜¤ë””ì˜¤ ëª¨ë¸ ìƒì„± &amp; ì¬ìƒ
                            </button>
                            <span id="part1-loading" class="hidden loading-spinner"></span>
                            <audio id="part1-audio-player" controls class="w-full max-w-[200px]"></audio>
                        </div>
                    </div>
                    
                    <div class="p-4 border-b pb-4">
                        <h4 class="text-2xl font-bold text-gray-800 mb-3">1. ì„¸ë°€í•œ ë°œìŒ í›ˆë ¨</h4>
                        <ul class="list-disc list-inside space-y-2 text-gray-700 ml-4">
                            <li>ìì£¼ í‹€ë¦¬ëŠ” ì†Œë¦¬: **'L'**ê³¼ **'R'**, **'F'**ì™€ **'P'** , **'V'**ì™€ **'B'** ì†Œë¦¬ë¥¼ êµ¬ë¶„í•˜ì—¬ ì •í™•íˆ ë‚¼ ìˆ˜ ìˆë„ë¡ ë°˜ë³µ í›ˆë ¨í•©ë‹ˆë‹¤.</li>
                            <li>ë³µìˆ˜í˜•/ê³¼ê±°í˜• ë ì†Œë¦¬: **'-s'**ë‚˜ **'-ed'**ê°€ ë¶™ì—ˆì„ ë•Œ, **/s/, /z/, /iz/** ë˜ëŠ” **/t/, /d/, /id/**ë¡œ ì–´ë–»ê²Œ ì†Œë¦¬ ë‚˜ëŠ”ì§€ ê·œì¹™ì„ ìˆ™ì§€í•©ë‹ˆë‹¤.</li>
                            <li>ëª¨ìŒì˜ ì¥ë‹¨ìŒ: **long vowel**ê³¼ **short vowel**ì˜ ì°¨ì´ë¥¼ ì˜ì‹í•˜ë©° ì—°ìŠµí•©ë‹ˆë‹¤. (ì˜ˆ: **'sheet'** vs **'shit'**)</li>
                        </ul>
                    </div>
                </div>

                <!-- ì—°ìŠµ ì™„ë£Œ ë²„íŠ¼ (ì§„ë„ ê´€ë¦¬ ê¸°ëŠ¥) -->
                <button onclick="window.generatePart1Passage()" class="mt-8 w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 transform hover:scale-[1.02] text-lg focus:outline-none focus:ring-4 focus:ring-indigo-300">
                    ğŸ”„ Part 1 ë“œë¦´ ìƒˆë¡œê³ ì¹¨ (ìƒˆë¡œìš´ ì§€ë¬¸ ìë™ ìƒì„±)
                </button>
            </article>

            <!-- Part 2 ì½˜í…ì¸  (ì‹¤ì „ ëª¨ë“œ ë° ëª¨ë²” ë‹µì•ˆ ì¶”ê°€ - ì´ë¯¸ì§€ ìƒì„±) -->
            <article id="part2" class="study-part bg-white p-6 sm:p-8 rounded-xl shadow-2xl hidden border-t-4 border-indigo-600">
                <h2 class="text-3xl font-extrabold text-indigo-700 mb-4">Part 2: ì‚¬ì§„ ë¬˜ì‚¬í•˜ê¸° (Describe a picture)</h2>
                <p class="text-gray-600 mb-6">ì¤€ë¹„ ì‹œê°„ 30ì´ˆ, ë‹µë³€ ì‹œê°„ 30ì´ˆ | 1ë¬¸í•­</p>
                
                <div class="space-y-6">
                    <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-400">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">âœ¨ Gemini Part 2 ì‹¤ì „ ë“œë¦´ (AI ì´ë¯¸ì§€ ìƒì„±)</h3>
                        <p class="text-gray-700 text-sm mb-3">ì›í•˜ëŠ” ì¸ì›ìˆ˜ë¥¼ ì„ íƒí•˜ê³ , ì‹¤ì „ íƒ€ì´ë¨¸ì™€ í•¨ê»˜ ì‚¬ì§„ì„ ë¬˜ì‚¬í•˜ì„¸ìš”. (ì—°ìŠµ ì™„ë£Œ ì‹œ ìë™ìœ¼ë¡œ íšŸìˆ˜ ê¸°ë¡)</p>
                        
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mb-4 items-center">
                            <select id="part2-people-count" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="a single">ğŸ‘¤ ì‚¬ëŒ 1ëª…</option>
                                <option value="two or three">ğŸ‘¥ ì‚¬ëŒ 2~3ëª…</option>
                                <option value="a large group of">ğŸ§‘â€ğŸ¤â€ğŸ§‘ ë‹¤ìˆ˜ (4ëª… ì´ìƒ)</option>
                            </select>
                            <button id="generate-part2-btn" onclick="window.generatePart2Practice()" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 disabled:opacity-50 flex items-center justify-center">
                                ğŸ“¸ ìƒˆë¡œìš´ ì‹œë‚˜ë¦¬ì˜¤ ìë™ ìƒì„± &amp; ì—°ìŠµ ì‹œì‘
                            </button>
                            <span id="part2-loading" class="hidden loading-spinner"></span>
                        </div>

                        <!-- íƒ€ì´ë¨¸ ë° ì‹œë‚˜ë¦¬ì˜¤ í‘œì‹œ ì˜ì—­ -->
                        <div class="flex flex-col md:flex-row items-start md:items-center space-y-4 md:space-y-0 md:space-x-4 mt-4 p-3 bg-gray-200 rounded-lg shadow-inner">
                            <div id="part2-timer-display" class="w-full md:w-28 text-center text-lg font-extrabold text-white p-2 rounded-lg bg-gray-500 shadow-md transition duration-300">
                                ëŒ€ê¸°
                            </div>
                            <div id="part2-scenario-output" class="flex-grow w-full text-gray-700 font-semibold text-sm min-h-[50px] overflow-hidden">
                                ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹¤ì „ ê°™ì€ ì‚¬ì§„ ë¬˜ì‚¬ ì‹œë‚˜ë¦¬ì˜¤(AI ì´ë¯¸ì§€)ë¥¼ ìƒì„±í•˜ì„¸ìš”.
                            </div>
                        </div>
                    </div>
                    
                    <!-- ëª¨ë²” ë‹µë³€ í‘œì‹œ ì˜ì—­ -->
                    <div class="bg-green-50 p-4 rounded-xl border border-green-200">
                        <h3 class="text-xl font-semibold text-green-700 mb-2">ğŸ’¡ ëª¨ë²” ë‹µë³€ í…œí”Œë¦¿ (ìµœëŒ€ 8ë¬¸ì¥)</h3>
                        <div id="part2-model-answer" class="mb-4">
                            <p class="text-gray-500">ë‹µë³€ ì‹œê°„ì´ ì¢…ë£Œë˜ë©´ ëª¨ë²” ë‹µë³€ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <!-- Part 2 ë§ŒëŠ¥ ë¬˜ì‚¬ í…œí”Œë¦¿ -->
                    <div class="bg-gray-100 p-6 rounded-lg">
                        <h4 class="text-2xl font-bold text-gray-800 mb-3">Part 2 ë§ŒëŠ¥ ë¬˜ì‚¬ í…œí”Œë¦¿ &amp; í•µì‹¬ íŒ</h4>
                        
                        <div class="space-y-4 mb-6">
                            <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200">
                                <h5 class="text-lg font-semibold text-indigo-700 mb-2">ğŸ‘¤ 1ì¸ ë¬˜ì‚¬ ì „ëµ</h5>
                                <p class="text-sm text-gray-700">ì¥ì†Œ â†’ ì¤‘ì‹¬ ì¸ë¬¼ + ë™ì‚¬ + ì‚¬ë¬¼ (ì¤‘ì‹¬ ì¸ë¬¼ 2~3ë¬¸ì¥ ë¬˜ì‚¬ë©´ ì¶©ë¶„)</p>
                                <ul class="list-disc list-inside text-sm text-gray-600 ml-4 mt-1">
                                    <li>ì¸ë¬¼ ë¬˜ì‚¬ ì‹œ ë¶„ì‚¬êµ¬ë¬¸ $wearing$ í™œìš©. (She is wearing~)</li>
                                    <li>ë°°ê²½ ë¬˜ì‚¬: ì‹ë¬¼(small/large/tall), ì•¡ì(hanging on the wall, bulletin board) ë“±ì„ í™œìš©.</li>
                                    <li>ë§ˆì§€ë§‰ $overall$ì€ peaceful ì™¸ì— ë¬˜ì‚¬í•  ìˆ˜ ìˆëŠ” ê°ì •ìœ¼ë¡œ ë§ˆë¬´ë¦¬ ì‹œ ê³ ë“ì  ìœ ë¦¬.</li>
                                </ul>
                            </div>
                            
                            <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200">
                                <h5 class="text-lg font-semibold text-indigo-700 mb-2">ğŸ‘¥ 2~3ì¸ ë¬˜ì‚¬ ì „ëµ</h5>
                                <p class="text-sm text-gray-700">ì¥ì†Œ â†’ ì¸ë¬¼ 1 â†’ ì¸ë¬¼ 2 (2ëª…ì¼ ë•Œ The other, another í™œìš©)</p>
                                <ul class="list-disc list-inside text-sm text-gray-600 ml-4 mt-1">
                                    <li>ë§ˆì£¼ ë³´ê³  ìˆì„ ë•Œ: $They \ are \ facing \ each \ other, \ and \ looking \ at \ each \ other.$</li>
                                    <li>ì¥ì†Œ/ì‚¬ë¬¼ ë¬˜ì‚¬: $On \ the \ table, \ there \ is~$, $In \ the \ background \ of \ the \ picture, \ ~$, $At \ the \ bottom \ of \ the \ picture, \ ~$</li>
                                    <li>ì‹œê°„ì´ ì—†ìœ¼ë¯€ë¡œ Overallì€ ìƒëµí•˜ê³  ë¬˜ì‚¬ì— ì§‘ì¤‘í•˜ëŠ” ê²ƒì´ ì•ˆì „.</li>
                                    <li>3ì¸ ì´ìƒ ë‹¤ìˆ˜ ë¬˜ì‚¬: ì¸ì›ë“¤ì„ ë¬¶ì–´ì„œ ë¬˜ì‚¬í•˜ë©° wearingì€ ë‹¨ì¼ ì¸ë¬¼ì—ê²Œ 1íšŒë§Œ í™œìš©.</li>
                                </ul>
                            </div>

                        </div>
                        
                        <h5 class="text-lg font-semibold text-red-700 mb-2 border-t pt-4">âŒ ì˜¤ë‹µ ë…¸íŠ¸ &amp; ì£¼ì˜ ì‚¬í•­</h5>
                        <ul class="list-disc list-inside text-sm text-gray-700 ml-4 space-y-1">
                            <li>ë‹¹ì—°í•œ ë™ì‘ ë¬˜ì‚¬ ì§€ì–‘: ì•‰ì•„ì„œ ë“œëŸ¼ ì¹˜ëŠ” ê²ƒ ë“± ë‹¹ì—°í•œ ë™ì‘ì€ ì¤‘ìš”í•˜ê²Œ ë¬˜ì‚¬í•  í•„ìš” ì—†ìŒ. ë‹¤ë¥¸ í•µì‹¬ì ì¸ ë¶€ë¶„ì„ ë¬˜ì‚¬.</li>
                            <li>ë™ì‚¬ ì¤‘ë³µ ì£¼ì˜: ë™ì‚¬ê°€ 2ê°œê°€ ë˜ì§€ ì•Šë„ë¡ ì£¼ì˜. are-ed í˜•íƒœì²˜ëŸ¼ be + p.p í˜•íƒœë„ ë™ì‚¬ ì¤‘ë³µì´ ì•„ë‹Œì§€ í™•ì¸.</li>
                            <li>ë¯¼ê°í•œ ì£¼ì œ ê¸ˆì§€: ì¸ì¢…, í”¼ë¶€ìƒ‰ ë“± ì˜ˆë¯¼í•  ìˆ˜ ìˆëŠ” ë¶€ë¶„ì€ ì–¸ê¸‰í•˜ì§€ ì•ŠìŒ.</li>
                        </ul>

                        <h5 class="text-lg font-semibold text-green-700 mb-2 border-t pt-4">âœ… í•µì‹¬ ë‹¨ì–´ ë° í‘œí˜„</h5>
                        <ul class="list-disc list-inside text-sm text-gray-700 ml-4 space-y-1">
                            <li>ì•…ê¸°: ë¬´ì¡°ê±´ ì •ê´€ì‚¬ $The$ ì‚¬ìš© (The drum, The piano).</li>
                            <li>ì¥ì†Œ/ì§ì—…: ì£¼ì°¨ì¥ (parking lot), íšŒì‚¬ì› (office worker), ì§ì› (a staff / an employee), ì œë³µ/ë‹¨ì²´ë³µ (Uniform).</li>
                            <li>ìœ„ì¹˜ í‘œí˜„: A man on the right, 2~3ëª…ì˜ ë‚¨ì êµ¬ë¶„ ì‹œ another í™œìš©.</li>
                            <li>í–‰ë™/ë™ì‚¬: looking at (ì³ë‹¤ë³´ê³  ìˆë‹¤), shopping around (ì‡¼í•‘í•˜ê³  ìˆë‹¤), talking to each other (ëŒ€í™”í•˜ê³  ìˆë‹¤).</li>
                            <li>ì¥ì†Œ ì• ë§¤ ì‹œ: It seems like this Picture was taken at a home office.</li>
                        </ul>
                    </div>
                </div>
            </article>

            <!-- Part 3 ì½˜í…ì¸  (ê°œë³„ ì§ˆë¬¸ ìƒì„±, íƒ€ì´ë¨¸, ë©”ëª¨, ëª¨ë²”ë‹µì•ˆ ì¶”ê°€) -->
            <article id="part3" class="study-part bg-white p-6 sm:p-8 rounded-xl shadow-2xl hidden border-t-4 border-indigo-600">
                <h2 class="text-3xl font-extrabold text-indigo-700 mb-4">Part 3: ì§ˆë¬¸ì— ë‹µí•˜ê¸° (Respond to questions)</h2>
                <p class="text-gray-600 mb-6">ì¤€ë¹„ ì‹œê°„ 3ì´ˆ, ë‹µë³€ ì‹œê°„ (15ì´ˆ, 15ì´ˆ, 30ì´ˆ) | 3ë¬¸í•­</p>
                
                <div class="space-y-6">
                    <div class="bg-purple-50 p-4 rounded-xl border-l-4 border-purple-400">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">âœ¨ Gemini Part 3 ì‹¤ì „ ë“œë¦´ (ë°°ê²½ ì‹œë‚˜ë¦¬ì˜¤ ê¸°ë°˜)</h3>
                        <div id="part3-control-buttons">
                            <label for="start-group-drill-btn" class="block text-sm font-medium text-gray-700 mb-2">ìƒˆë¡œìš´ ì£¼ì œ ì„¸íŠ¸ ìƒì„±</label>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mb-4 items-center">
                                <button id="start-group-drill-btn" onclick="window.generatePart3Questions()" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 disabled:opacity-50 flex items-center justify-center">
                                    â“ ìƒˆë¡œìš´ ì£¼ì œ ë° Q1~Q3 ìë™ ìƒì„±
                                </button>
                                <span id="part3-drill-loading" class="hidden loading-spinner"></span>
                            </div>
                            <p id="part3-question-context" class="text-sm text-gray-600 font-semibold mt-2 whitespace-pre-line">ìƒˆë¡œìš´ ì£¼ì œ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìƒì„±í•˜ì—¬ ì—°ìŠµì„ ì‹œì‘í•˜ì„¸ìš”.</p>
                            
                            <button id="start-drill-btn" onclick="window.startPart3Drill()" class="mt-4 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 disabled:opacity-50 flex items-center justify-center text-lg">
                                â–¶ï¸ ì—°ìŠµ ì‹œì‘ (Q1ë¶€í„° ìˆœì°¨ ì§„í–‰)
                            </button>
                            <audio id="part3-audio-player" class="w-full max-w-[200px] mt-2 hidden" controls></audio>
                        </div>

                        <!-- íƒ€ì´ë¨¸ ë° ì§ˆë¬¸ í‘œì‹œ ì˜ì—­ -->
                        <div class="flex items-center space-x-4 mt-4 p-3 bg-gray-200 rounded-lg shadow-inner">
                            <div id="part3-timer-display" class="w-28 text-center text-lg font-extrabold text-white p-2 rounded-lg bg-gray-500 shadow-md transition duration-300">
                                ëŒ€ê¸°
                            </div>
                            <div id="part3-current-question" class="flex-grow text-gray-700 font-semibold min-h-[50px] flex flex-col justify-center">
                                <p class="text-gray-500">Q1~Q3 ì§ˆë¬¸ì´ ìˆœì„œëŒ€ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ëª¨ë²” ë‹µë³€ í‘œì‹œ ì˜ì—­ -->
                    <div class="bg-green-50 p-4 rounded-xl border border-green-200">
                        <h3 class="text-xl font-semibold text-green-700 mb-2">ğŸ’¡ ëª¨ë²” ë‹µë³€ ì„¸íŠ¸</h3>
                        <div id="part3-model-answer" class="mb-4">
                            <p class="text-gray-500">ì—°ìŠµì´ ì™„ë£Œë˜ë©´ Q1~Q3 ëª¨ë²” ë‹µë³€ ì„¸íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <!-- ì—°ìŠµ í›„ ë©”ëª¨ ê¸°ë¡ ì˜ì—­ -->
                    <div id="part3-memo-area" class="hidden bg-red-50 p-6 rounded-xl border-2 border-red-400">
                        <h3 class="text-xl font-bold text-red-700 mb-3">ğŸ“ ì…€í”„ í”¼ë“œë°± ê¸°ë¡ (ì˜¤ë‹µ ë…¸íŠ¸)</h3>
                        <p class="text-sm text-gray-700 mb-3">ì—°ìŠµì„ ë§ˆì³¤ìŠµë‹ˆë‹¤! ìŠ¤ìŠ¤ë¡œ ì˜í•œ ì ê³¼ ë¶€ì¡±í•œ ì ì„ ê¸°ë¡í•˜ì—¬ í•™ìŠµ ê¸°ë¡ìœ¼ë¡œ ë‚¨ê¸°ì„¸ìš”. (ìë™ìœ¼ë¡œ ì—°ìŠµ íšŸìˆ˜ê°€ ê¸°ë¡ë©ë‹ˆë‹¤.)</p>
                        
                        <textarea id="part3-memo-input" class="w-full p-3 border rounded-lg focus:ring-red-500 focus:border-red-500 text-sm" rows="5" placeholder="ì˜ˆ: 'ìœ ì°½ì„±'ì€ ì¢‹ì•˜ìœ¼ë‚˜ 'ë‘ ë²ˆì§¸ ì´ìœ 'ë¥¼ ì œì‹œí•  ë•Œ ë¬¸ë²• ì˜¤ë¥˜ê°€ ìˆì—ˆë‹¤. ë‹¤ìŒì— ê°œì„ í•  ì ì€ 'ì‹œê°„ ê´€ë¦¬'ì™€ 'ë‹¤ì–‘í•œ ì–´íœ˜' ì‚¬ìš©."></textarea>
                        
                        <button id="save-memo-btn" onclick="window.savePart3Memo()" class="mt-3 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-200">
                            ë©”ëª¨ ê¸°ë¡ ì €ì¥
                        </button>
                    </div>

                    <div class="bg-gray-100 p-6 rounded-lg">
                        <h4 class="text-2xl font-bold text-gray-800 mb-3">Part 3 ë‹µë³€ ì „ëµ</h4>
                        <p class="text-gray-700 font-medium mb-3">Q1, Q2 (15ì´ˆ ë‹µë³€): ê°„ê²°í•œ ë‹µë³€ì„ ëª©í‘œë¡œ í•˜ë©°, í•µì‹¬ ì£¼ì¥(Point)ê³¼ ì´ìœ  1ê°œ(Reason)ë§Œìœ¼ë¡œ ë‹µë³€ì„ ëë‚´ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</p>
                        <p class="text-gray-700 font-medium mb-4">Q3 (30ì´ˆ ë‹µë³€): ë‹µë³€ì„ ê¸¸ê²Œ êµ¬ì„±í•´ì•¼ í•˜ë¯€ë¡œ í•µì‹¬ ì£¼ì¥(Point) â†’ ì´ìœ  1(Reason) â†’ ìƒì„¸ ì„¤ëª…/ì˜ˆì‹œ(Detail) â†’ ì´ìœ  2(Reason) ë˜ëŠ” ì–‘ì ë¹„êµ ë“±ì˜ êµ¬ì¡°ë¥¼ í™œìš©í•˜ì—¬ ì‹œê°„ì„ ì±„ìš°ëŠ” ì—°ìŠµì´ ì¤‘ìš”í•©ë‹ˆë‹¤.</p>
                        <hr class="my-4">
                        <p class="text-sm text-gray-600">ì°¸ê³ : ì´ ëª¨ë²” ë‹µë³€ êµ¬ì¡°ëŠ” ë…¼ë¦¬ì ì¸ íë¦„ì„ ë¹ ë¥´ê²Œ ì¡ê³  ì˜¤ë‹µì„ ì¤„ì´ëŠ” ë° ì´ˆì ì„ ë§ì¶”ê³  ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>

                <button onclick="window.generatePart3Questions()" class="mt-8 w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 transform hover:scale-[1.02] text-lg focus:outline-none focus:ring-4 focus:ring-indigo-300">
                    ğŸ”„ Part 3 ë“œë¦´ ìƒˆë¡œê³ ì¹¨ (ìƒˆë¡œìš´ ì£¼ì œ ì„¸íŠ¸ ìë™ ìƒì„±)
                </button>
            </article>
            
            <!-- Part 4 ì½˜í…ì¸  (ë„í‘œ ìë™ ìƒì„± ê¸°ëŠ¥ ë° ì§ˆë¬¸ ìƒì„±/TTS, íƒ€ì´ë¨¸ ì¶”ê°€) -->
            <article id="part4" class="study-part bg-white p-6 sm:p-8 rounded-xl shadow-2xl hidden border-t-4 border-indigo-600">
                <h2 class="text-3xl font-extrabold text-indigo-700 mb-4">Part 4: ì œê³µëœ ì •ë³´ë¥¼ ì´ìš©í•´ ì§ˆë¬¸ì— ë‹µí•˜ê¸° (Respond to questions using information provided)</h2>
                <p class="text-gray-600 mb-6">ì¤€ë¹„ ì‹œê°„ 45ì´ˆ, ë‹µë³€ ì‹œê°„ (15ì´ˆ, 15ì´ˆ, 30ì´ˆ) | 3ë¬¸í•­</p>
                
                <div class="space-y-6">
                    <div class="bg-teal-50 p-4 rounded-lg border-l-4 border-teal-400">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">ğŸ“Š Gemini Part 4 ì‹¤ì „ ë“œë¦´ (ë„í‘œ ìƒì„± ë° íƒ€ì´ë¨¸)</h3>
                        <p class="text-gray-700 text-sm mb-3">ìƒˆ ë„í‘œ ìƒì„± í›„, ì—°ìŠµ ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì‹¤ì „ì²˜ëŸ¼ 45ì´ˆ ì¤€ë¹„ í›„ ì§ˆë¬¸ì´ ìˆœì°¨ì ìœ¼ë¡œ ì¬ìƒë©ë‹ˆë‹¤.</p>
                        
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mb-4 items-center">
                            <button id="generate-part4-btn" onclick="window.generatePart4Data()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 disabled:opacity-50 flex items-center">
                                âœ¨ ìƒˆ ë„í‘œ/ì§ˆë¬¸ ìë™ ìƒì„±
                            </button>
                            <span id="part4-loading" class="hidden loading-spinner"></span>
                        </div>

                        <!-- ë„í‘œ ë°ì´í„° í‘œì‹œ ì˜ì—­ -->
                        <div id="part4-data-output" class="text-gray-700 min-h-[100px] border border-gray-300 rounded-lg p-2 bg-white">
                            <p class="text-gray-500 p-4">ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒˆë¡œìš´ ì—°ìŠµìš© ë„í‘œë¥¼ ìƒì„±í•˜ì„¸ìš”.</p>
                        </div>
                    </div>

                    <!-- ì§ˆë¬¸ ë° íƒ€ì´ë¨¸ ì˜ì—­ -->
                    <div id="part4-questions-area" class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-400 hidden">
                        <h3 class="text-xl font-semibold text-purple-800 mb-3">â±ï¸ ì‹¤ì „ ì—°ìŠµ ëª¨ë“œ</h3>
                        
                        <!-- íƒ€ì´ë¨¸ ë° ì»¨íŠ¸ë¡¤ -->
                        <div class="flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-4 mb-4">
                            <button id="start-part4-drill-btn" onclick="window.startPart4Drill()" class="w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 disabled:opacity-50 flex items-center justify-center text-lg">
                                â–¶ï¸ ì—°ìŠµ ì‹œì‘ (45ì´ˆ ì¤€ë¹„)
                            </button>
                            <div id="part4-timer-display" class="w-28 text-center text-xl font-extrabold text-white p-2 rounded-lg bg-gray-500 shadow-md transition duration-300">
                                ëŒ€ê¸°
                            </div>
                            <audio id="part4-audio-player" class="w-full max-w-[200px]" controls></audio>
                        </div>

                        <p class="text-sm text-gray-700 mb-2">ì§ˆë¬¸ ëª©ë¡: (ì§ˆë¬¸ì€ ì—°ìŠµ ì‹œì‘ í›„ TTSë¡œ ìˆœì°¨ì ìœ¼ë¡œ ì¬ìƒë©ë‹ˆë‹¤)</p>
                        <div id="part4-question-list" class="bg-white border rounded-lg p-3">
                            <span id="part4-questions-loading" class="hidden loading-spinner"></span>
                        </div>
                    </div>
                
                    <div class="bg-gray-100 p-6 rounded-lg">
                        <h4 class="text-2xl font-bold text-gray-800 mb-3">Part 4 ì •ë³´ í™œìš© ì „ëµ (í† ê¸€)</h4>

                        <details class="mb-3 p-3 bg-white rounded-lg shadow-sm">
                            <summary class="font-semibold text-indigo-700 cursor-pointer">ğŸ“ ì •ë³´ íŒŒì•… ë° ë‹µë³€ ê¸°ë³¸ êµ¬ì¡°</summary>
                            <div class="text-sm text-gray-700 mt-2 ml-4 space-y-2">
                                <p><strong>45ì´ˆ ì¤€ë¹„ ì‹œê°„ ë™ì•ˆ:</strong> í–‰ì‚¬ ì¢…ë¥˜, ì—´ë¦¬ëŠ” ì‹œê°„/ì¥ì†Œ, ë³€ê²½ëœ ì •ë³´(ì·¨ì†Œ/ë³€ê²½) ë° í‘œ ì•„ë˜ ì¶”ê°€ ì •ë³´(ê°€ê²©, ëŒ€ìƒ)ë¥¼ ë¬´ì¡°ê±´ í™•ì¸í•©ë‹ˆë‹¤.</p>
                                <p><strong>Q10 (ë‹¨ìˆœ ì •ë³´):</strong> Sure. There is two scheduled sessions. First, [ê°•ì‚¬] will teach a class... Second, another class... (2ê°€ì§€ ìŠ¤ì¼€ì¤„ì„ ìˆœì„œëŒ€ë¡œ ì–¸ê¸‰)</p>
                                <p><strong>Q11 (ì„¸ë¶€ ì •ë³´):</strong> ì§ˆë¬¸ì—ì„œ ìš”êµ¬í•˜ëŠ” ì„¸ë¶€ ì •ë³´(ì‹œê°„, ì¥ì†Œ, ë°œí‘œì)ë¥¼ ì •í™•íˆ í™•ì¸í•˜ì—¬ ë‹µë³€í•©ë‹ˆë‹¤.</p>
                                <p><strong>Q12 (ì˜ëª»ëœ ì •ë³´/ë¹„êµ):</strong> 'Iâ€™m sorry, but you have the wrong information.' + ì˜¬ë°”ë¥¸ ì •ë³´(1, 2ë²ˆ í…œí”Œë¦¿ ì‚¬ìš©)ë¡œ ê³ ì³ì¤ë‹ˆë‹¤. ì‹œê°„ì´ ë‚¨ìœ¼ë©´ 'So, Itâ€™s okay.'ë¡œ ë§ˆë¬´ë¦¬í•©ë‹ˆë‹¤.</p>
                            </div>
                        </details>

                        <details class="mb-3 p-3 bg-white rounded-lg shadow-sm">
                            <summary class="font-semibold text-indigo-700 cursor-pointer">ğŸ—£ï¸ ë§ŒëŠ¥ ë‹µë³€ í…œí”Œë¦¿ ë° í‘œí˜„</summary>
                            <div class="text-sm text-gray-700 mt-2 ml-4 space-y-2">
                                <p><strong>ì´ë¦„/íšŒì‚¬ëª… ë°˜ë³µ:</strong> ì²˜ìŒ ë“±ì¥ ì‹œ ì´ë¦„ì„, ë‹¤ìŒì—” ì„±ì„ ë˜ëŠ” He/Sheë¡œ ì§€ì¹­í•˜ë©° 2íšŒ ì´ìƒ ì½ìŠµë‹ˆë‹¤.</p>
                                <p><strong>í–‰ì‚¬ ì‹œì‘/ì˜ˆì •:</strong> <br/>
                                    - ì‚¬ëŒ ì´ë¦„ ì—†ì„ ì‹œ: The conference on [ì£¼ì œ] is scheduled at [ì‹œê°]. <br/>
                                    - ì‚¬ëŒ ì´ë¦„ ìˆì„ ì‹œ: [ì‚¬ëŒ] will give a speech on [ì£¼ì œ] at [ì‹œê°].</p>
                                <p><strong>í–‰ì‚¬ ì¢…ë£Œ:</strong> It will finish at [ì‹œê°„].</p>
                                <p><strong>ì˜ëª»ëœ ì •ë³´ ê³ ì¹˜ê¸°:</strong> Iâ€™m sorry, but you have the wrong information. First, [ì˜¬ë°”ë¥¸ ì •ë³´].</p>
                                <p><strong>íŠ¹ì´í•œ ì •ë³´:</strong> ê°€ê²©, ë“±ë¡ ë§ˆê°ì¼ (You should register by [ë“±ë¡ë§ˆê°ì¼]), ëŒ€ìƒ (It's for beginners.) ë“± í‘œ ì•„ë˜ ì •ë³´ë¥¼ ì–¸ê¸‰í•˜ë©´ ê³ ë“ì .</p>
                            </div>
                        </details>
                        
                        <details class="p-3 bg-white rounded-lg shadow-sm">
                            <summary class="font-semibold text-indigo-700 cursor-pointer">ğŸ“Œ ì „ì¹˜ì‚¬ ë° ì„œìˆ˜ í™œìš© íŒ</summary>
                            <div class="text-sm text-gray-700 mt-2 ml-4 space-y-2">
                                <p><strong>ì „ì¹˜ì‚¬:</strong> <br/>
                                    - at: ì‹œê° (at 5 pm), ê±´ë¬¼ëª…/ë²ˆì§€ìˆ˜ (at the community center)</p>
                                    - in: ì—°ë„/ì›”/ê³„ì ˆ, ë„ì‹œ (in 2025), ì‹¤ë‚´ ì¥ì†Œ ê°•ì¡° (in my office)</p>
                                    - on: ë‚ ì§œ/ìš”ì¼ (on Mondays), ì¸í„°ë„· (on the internet), ì£¼ì œ (on the topic of...)</p>
                                <p><strong>ì„œìˆ˜ ë°œìŒ:</strong> 13~19thì˜ teen ë°œìŒì„ ê¸¸ê²Œ ëŒì–´ì£¼ì–´ ëª…í™•í•˜ê²Œ ë°œìŒí•©ë‹ˆë‹¤.</p>
                            </div>
                        </details>
                    </div>
                </div>
            </article>
            
            <!-- Part 5 ì½˜í…ì¸  (ë¬¸ì œ ìƒì„± ê¸°ëŠ¥ ë° íƒ€ì´ë¨¸, ëª¨ë²” ë‹µë³€ ì¶”ê°€) -->
            <article id="part5" class="study-part bg-white p-6 sm:p-8 rounded-xl shadow-2xl hidden border-t-4 border-indigo-600">
                <h2 class="text-3xl font-extrabold text-indigo-700 mb-4">Part 5: ì˜ê²¬ ì œì‹œí•˜ê¸° (Express an Opinion)</h2>
                <p class="text-gray-600 mb-6">ì¤€ë¹„ ì‹œê°„ 45ì´ˆ, ë‹µë³€ ì‹œê°„ 60ì´ˆ | 1ë¬¸í•­</p>

                <div class="space-y-6">
                    <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-400">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">âœ¨ Gemini Part 5 ì‹¤ì „ ë“œë¦´ (ì„ íƒì§€ ê¸°ë°˜)</h3>
                        <p class="text-gray-700 text-sm mb-3">ë²„íŠ¼ì„ ëˆŒëŸ¬ **ì„ íƒì§€ ê¸°ë°˜ ì˜ê²¬ ì œì‹œ ì£¼ì œ**ë¥¼ ìƒì„±í•˜ê³ , íƒ€ì´ë¨¸ì™€ í•¨ê»˜ ì—°ìŠµí•˜ì„¸ìš”.</p>
                        
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mb-4 items-center">
                            <button id="generate-part5-btn" onclick="window.generatePart5Problem()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 disabled:opacity-50 flex items-center justify-center">
                                âœ¨ ìƒˆ ì˜ê²¬ ì œì‹œ ì£¼ì œ ìƒì„±
                            </button>
                            <span id="part5-loading" class="hidden loading-spinner"></span>
                        </div>

                        <!-- íƒ€ì´ë¨¸ ë° ì‹œë‚˜ë¦¬ì˜¤ í‘œì‹œ ì˜ì—­ -->
                        <div class="flex flex-col md:flex-row items-start md:items-center space-y-4 md:space-y-0 md:space-x-4 mt-4 p-3 bg-gray-200 rounded-lg shadow-inner">
                            <button id="start-part5-drill-btn" onclick="window.startPart5Drill()" class="w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 disabled:opacity-50 flex items-center justify-center text-lg">
                                â–¶ï¸ ì—°ìŠµ ì‹œì‘ (45ì´ˆ ì¤€ë¹„)
                            </button>
                            <div id="part5-timer-display" class="w-full md:w-28 text-center text-xl font-extrabold text-white p-2 rounded-lg bg-gray-500 shadow-md transition duration-300">
                                ëŒ€ê¸°
                            </div>
                        </div>

                        <p id="part5-problem-output" class="text-gray-700 p-3 bg-white border border-gray-300 rounded-lg min-h-[80px] mt-4">
                            ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹¤ì „ ê°™ì€ Part 5 ì˜ê²¬ ì œì‹œ ì£¼ì œë¥¼ ìƒì„±í•˜ì„¸ìš”.
                        </p>
                    </div>

                    <!-- ëª¨ë²” ë‹µë³€ í‘œì‹œ ì˜ì—­ -->
                    <div class="bg-green-50 p-4 rounded-xl border border-green-200">
                        <h3 class="text-xl font-semibold text-green-700 mb-2">ğŸ’¡ ëª¨ë²” ë‹µë³€ (ë§ŒëŠ¥ í…œí”Œë¦¿ í™œìš©)</h3>
                        <div id="part5-model-answer" class="mb-4">
                            <p class="text-gray-500">ë‹µë³€ ì‹œê°„ì´ ì¢…ë£Œë˜ë©´ ëª¨ë²” ë‹µë³€ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <div class="bg-gray-100 p-6 rounded-lg">
                        <h4 class="text-2xl font-bold text-gray-800 mb-3">Part 5 ì˜ê²¬ ì œì‹œ ì „ëµ (í† ê¸€)</h4>

                        <details class="mb-3 p-3 bg-white rounded-lg shadow-sm">
                            <summary class="font-semibold text-indigo-700 cursor-pointer">ğŸ“Œ ë‹µë³€ êµ¬ì„± ìˆœì„œ ë° ì…ì¥ ê²°ì •</summary>
                            <div class="text-sm text-gray-700 mt-2 ml-4 space-y-2">
                                <p><strong>ê¸°ë³¸ ìˆœì„œ:</strong> ì…ì¥ ê²°ì • â†’ ì´ìœ  ì„¤ëª… (2ë¬¸ì¥) â†’ ì˜ˆì‹œ ì„¤ëª… â†’ ë§ˆë¬´ë¦¬ (ë‹¤ì‹œ í•œ ë²ˆ ì˜ê²¬ ë‚¨ê¸°ê¸°)</p>
                                <p><strong>ì…ì¥ ê²°ì • í…œí”Œë¦¿:</strong> <br/>
                                    - ë™ì˜/ë¹„ë™ì˜ ì‹œ: $I \ agree \ that \ [ì œì‹œë¬¸ \ ê·¸ëŒ€ë¡œ]$ ë˜ëŠ” $I \ disagree \ with \ the \ statement.$ <br/>
                                    - ì„ íƒì§€ íƒì¼ ì‹œ: $I \ would \ choose \ [ì„ íƒì§€]$ ë˜ëŠ” $I \ think \ [ì„ íƒì§€] \ is \ the \ most \ important...$ <br/>
                                    - ì—°ê²° ë¬¸ì¥: $Let \ me \ explain \ why \ I \ think \ this \ way.$</p>
                            </div>
                        </details>

                        <details class="mb-3 p-3 bg-white rounded-lg shadow-sm">
                            <summary class="font-semibold text-indigo-700 cursor-pointer">ğŸ—£ï¸ ì´ìœ  ë° ì˜ˆì‹œ í™œìš© íŒ</summary>
                            <div class="text-sm text-gray-700 mt-2 ml-4 space-y-2">
                                <p><strong>ì´ìœ  ì„¤ëª… ì‹œì‘:</strong> $Most \ of \ all, \ Because$ ë¡œ ì‹œì‘í•˜ëŠ” ê²ƒì„ ì„ í˜¸í•©ë‹ˆë‹¤.</p>
                                <p><strong>ì£¼ì–´ í™œìš©:</strong> 1ì¸ì¹­ ì£¼ì–´ 'I' ì‚¬ìš©ì„ í”¼í•˜ê³ , **we, they, it, there** ë“± 2/3ì¸ì¹­ ì£¼ì–´ë¥¼ í™œìš©í•˜ì—¬ ë‹µë³€ì˜ ê°ê´€ì„±ê³¼ ì„¤ë“ë ¥ì„ ë†’ì…ë‹ˆë‹¤.</p>
                                <p><strong>ì˜ˆì‹œ í™œìš©:</strong> <br/>
                                    - ê°œì¸ ê²½í—˜: $From \ my \ experience, \ When \ I \ was \ in \ college...$ <br/>
                                    - ë‰´ìŠ¤ ì¸ìš©: $According \ to \ a \ recent \ news \ reports, \ the \ majority \ of...$</p>
                                <p><strong>ë¬¸ì¥ ì—°ê²°:</strong> $And, \ So, \ Because$ ë¥¼ í™œìš©í•˜ì—¬ ê°„ë‹¨í•œ ë¬¸ì¥ ì—¬ëŸ¬ ê°œë¥¼ ì—°ê²°í•˜ë©´ ìœ ì°½ì„±ì´ ë†’ì•„ì§‘ë‹ˆë‹¤.</p>
                            </div>
                        </details>
                        
                        <details class="p-3 bg-white rounded-lg shadow-sm">
                            <summary class="font-semibold text-indigo-700 cursor-pointer">âœ… ë§ŒëŠ¥ ë¬¸ì¥ (í™œìš© ë¹ˆë„ ë†’ìŒ)</summary>
                            <div class="text-sm text-gray-700 mt-2 ml-4 space-y-2">
                                <p><strong>ê¸ì •ì  íš¨ê³¼:</strong> They can make a friendly work atmosphere. / Employees can work more efficiently and productively. / Itâ€™s very fun and entertaining. / We can live a comfortable life financially.</p>
                                <p><strong>ì •ë³´/ì„ íƒ:</strong> Most of all, we can get a lot of useful information from a wide variety of products. / As a result, I can select and get more information.</p>
                                <p><strong>ìŠ¤íŠ¸ë ˆìŠ¤/ì§‘ì¤‘:</strong> As a result, I could forget my worries about stress. / It could be difficult to concentrate on studies. / I can focus better.</p>
                                <p><strong>ë§ˆë¬´ë¦¬:</strong> As a result, I was able to enjoy work. / Therefore, I think this way.</p>
                            </div>
                        </details>
                    </div>
                </div>

                <button onclick="window.generatePart5Problem()" class="mt-8 w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 transform hover:scale-[1.02] text-lg focus:outline-none focus:ring-4 focus:ring-indigo-300">
                    ğŸ”„ Part 5 ë“œë¦´ ìƒˆë¡œê³ ì¹¨ (ìƒˆ ë¬¸ì œ ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±)
                </button>
            </article>

        </section>
        <!-- === ì½˜í…ì¸  ì˜ì—­ ë === -->

    </main>

    <footer class="bg-gray-800 text-white text-center p-4 mt-8">
        <p class="text-sm">Made with ğŸ’– for a great portfolio. &copy; 2024</p>
    </footer>
</body>
</html>
